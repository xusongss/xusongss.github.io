<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="第五章 高级发布-订阅模式第三章和第四章讲述了ZMQ中请求-应答模式的一些高级用法。如果你已经能够彻底理解了，那我要说声恭喜。这一章我们会关注发布-订阅模式，使用上层模式封装，提升ZMQ发布-订阅模式的性能、可靠性、状态同步及安全机制。 本章涉及的内容有：  处理慢订阅者（自杀的蜗牛模式） 高速订阅者（黑箱模式） 构建一个共享键值缓存（克隆模式）  检测慢订阅者（自杀的蜗牛模式）在使用发布-订阅模">
<meta name="keywords">
<meta property="og:type" content="article">
<meta property="og:title" content="zmq-chapter5">
<meta property="og:url" content="http://yoursite.com/2017/03/02/zmq-chapter5/index.html">
<meta property="og:site_name" content="绿色回忆">
<meta property="og:description" content="第五章 高级发布-订阅模式第三章和第四章讲述了ZMQ中请求-应答模式的一些高级用法。如果你已经能够彻底理解了，那我要说声恭喜。这一章我们会关注发布-订阅模式，使用上层模式封装，提升ZMQ发布-订阅模式的性能、可靠性、状态同步及安全机制。 本章涉及的内容有：  处理慢订阅者（自杀的蜗牛模式） 高速订阅者（黑箱模式） 构建一个共享键值缓存（克隆模式）  检测慢订阅者（自杀的蜗牛模式）在使用发布-订阅模">
<meta property="og:updated_time" content="2017-04-28T05:42:32.984Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="zmq-chapter5">
<meta name="twitter:description" content="第五章 高级发布-订阅模式第三章和第四章讲述了ZMQ中请求-应答模式的一些高级用法。如果你已经能够彻底理解了，那我要说声恭喜。这一章我们会关注发布-订阅模式，使用上层模式封装，提升ZMQ发布-订阅模式的性能、可靠性、状态同步及安全机制。 本章涉及的内容有：  处理慢订阅者（自杀的蜗牛模式） 高速订阅者（黑箱模式） 构建一个共享键值缓存（克隆模式）  检测慢订阅者（自杀的蜗牛模式）在使用发布-订阅模">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/03/02/zmq-chapter5/"/>





  <title>zmq-chapter5 | 绿色回忆</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">绿色回忆</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">程序猿 攻城狮</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/02/zmq-chapter5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="徐松">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="绿色回忆">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                zmq-chapter5
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-02T00:00:45+08:00">
                2017-03-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="第五章-高级发布-订阅模式"><a href="#第五章-高级发布-订阅模式" class="headerlink" title="第五章 高级发布-订阅模式"></a>第五章 高级发布-订阅模式</h2><p>第三章和第四章讲述了ZMQ中请求-应答模式的一些高级用法。如果你已经能够彻底理解了，那我要说声恭喜。这一章我们会关注发布-订阅模式，使用上层模式封装，提升ZMQ发布-订阅模式的性能、可靠性、状态同步及安全机制。</p>
<p>本章涉及的内容有：</p>
<ul>
<li>处理慢订阅者（自杀的蜗牛模式）</li>
<li>高速订阅者（黑箱模式）</li>
<li>构建一个共享键值缓存（克隆模式）</li>
</ul>
<h3 id="检测慢订阅者（自杀的蜗牛模式）"><a href="#检测慢订阅者（自杀的蜗牛模式）" class="headerlink" title="检测慢订阅者（自杀的蜗牛模式）"></a>检测慢订阅者（自杀的蜗牛模式）</h3><p>在使用发布-订阅模式的时候，最常见的问题之一是如何处理响应较慢的订阅者。理想状况下，发布者能以全速发送消息给订阅者，但现实中，订阅者会需要对消息做较长时间的处理，或者写得不够好，无法跟上发布者的脚步。</p>
<p>如何处理慢订阅者？最好的方法当然是让订阅者高效起来，不过这需要额外的工作。以下是一些处理慢订阅者的方法：</p>
<ul>
<li><p><strong>在发布者中贮存消息</strong>。这是Gmail的做法，如果过去的几小时里没有阅读邮件的话，它会把邮件保存起来。但在高吞吐量的应用中，发布者堆积消息往往会导致内存溢出，最终崩溃。特别是当同是有多个订阅者时，或者无法用磁盘来做一个缓冲，情况就会变得更为复杂。</p>
</li>
<li><p><strong>在订阅者中贮存消息</strong>。这种做法要好的多，其实ZMQ默认的行为就是这样的。如果非得有一个人会因为内存溢出而崩溃，那也只会是订阅者，而非发布者，这挺公平的。然而，这种做法只对瞬间消息量很大的应用才合理，订阅者只是一时处理不过来，但最终会赶上进度。但是，这还是没有解决订阅者速度过慢的问题。</p>
</li>
<li><p><strong>暂停发送消息</strong>。这也是Gmail的做法，当我的邮箱容量超过7.554GB时，新的邮件就会被Gmail拒收或丢弃。这种做法对发布者来说很有益，ZMQ中若设置了阈值（HWM），其默认行为也就是这样的。但是，我们仍不能解决慢订阅者的问题，我们只是让消息变得断断续续而已。</p>
</li>
<li><p><strong>断开与满订阅者的连接</strong>。这是hotmail的做法，如果连续两周没有登录，它就会断开，这也是为什么我正在使用第十五个hotmail邮箱。不过这种方案在ZMQ里是行不通的，因为对于发布者而言，订阅者是不可见的，无法做相应处理。</p>
</li>
</ul>
<p>看来没有一种经典的方式可以满足我们的需求，所以我们就要进行创新了。我们可以让订阅者自杀，而不仅仅是断开连接。这就是“自杀的蜗牛”模式。当订阅者发现自身运行得过慢时（对于慢速的定义应该是一个配置项，当达到这个标准时就大声地喊出来吧，让程序员知道），它会哀嚎一声，然后自杀。</p>
<p>订阅者如何检测自身速度过慢呢？一种方式是为消息进行编号，并在发布者端设置阈值。当订阅者发现消息编号不连续时，它就知道事情不对劲了。这里的阈值就是订阅者自杀的值。</p>
<p>这种方案有两个问题：一、如果我们连接的多个发布者，我们要如何为消息进行编号呢？解决方法是为每一个发布者设定一个唯一的编号，作为消息编号的一部分。二、如果订阅者使用ZMQ_SUBSRIBE选项对消息进行了过滤，那么我们精心设计的消息编号机制就毫无用处了。</p>
<p>有些情形不会进行消息的过滤，所以消息编号还是行得通的。不过更为普遍的解决方案是，发布者为消息标注时间戳，当订阅者收到消息时会检测这个时间戳，如果其差别达到某一个值，就发出警报并自杀。</p>
<p>当订阅者有自身的客户端或服务协议，需要保证最大延迟时间时，自杀的蜗牛模式会很合适。撤销一个订阅者也许并不是最周全的方案，但至少不会引发后续的问题。如果订阅者收到了过时的消息，那可能会对数据造成进一步的破坏，而且很难被发现。<br><a id="more"></a><br>以下是自杀的蜗牛模式的最简实现：</p>
<p><strong>suisnail: Suicidal Snail in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  自杀的蜗牛模式</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"czmq.h"</span></span></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  该订阅者会连接至发布者，接收所有的消息，</span></div><div class="line"><span class="comment">//  运行过程中它会暂停一会儿，模拟复杂的运算过程，</span></div><div class="line"><span class="comment">//  当发现收到的消息超过1秒的延迟时，就自杀。</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_ALLOWED_DELAY   1000    <span class="comment">//  毫秒</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">subscriber</span> <span class="params">(<span class="keyword">void</span> *args, <span class="keyword">zctx_t</span> *ctx, <span class="keyword">void</span> *pipe)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//  订阅所有消息</span></div><div class="line">    <span class="keyword">void</span> *subscriber = zsocket_new (ctx, ZMQ_SUB);</div><div class="line">    zsocket_connect (subscriber, <span class="string">"tcp://localhost:5556"</span>);</div><div class="line"></div><div class="line">    <span class="comment">//  获取并处理消息</span></div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">char</span> *<span class="built_in">string</span> = zstr_recv (subscriber);</div><div class="line">        <span class="keyword">int64_t</span> clock;</div><div class="line">        <span class="keyword">int</span> terms = <span class="built_in">sscanf</span> (<span class="built_in">string</span>, <span class="string">"%"</span> PRId64, &amp;clock);</div><div class="line">        assert (terms == <span class="number">1</span>);</div><div class="line">        <span class="built_in">free</span> (<span class="built_in">string</span>);</div><div class="line"></div><div class="line">        <span class="comment">//  自杀逻辑</span></div><div class="line">        <span class="keyword">if</span> (zclock_time () - clock &gt; MAX_ALLOWED_DELAY) &#123;</div><div class="line">            <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"E: 订阅者无法跟进, 取消中\n"</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  工作一定时间</span></div><div class="line">        zclock_sleep (<span class="number">1</span> + randof (<span class="number">2</span>));</div><div class="line">    &#125;</div><div class="line">    zstr_send (pipe, <span class="string">"订阅者中止"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  发布者每毫秒发送一条用时间戳标记的消息</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">publisher</span> <span class="params">(<span class="keyword">void</span> *args, <span class="keyword">zctx_t</span> *ctx, <span class="keyword">void</span> *pipe)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//  准备发布者</span></div><div class="line">    <span class="keyword">void</span> *publisher = zsocket_new (ctx, ZMQ_PUB);</div><div class="line">    zsocket_bind (publisher, <span class="string">"tcp://*:5556"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        <span class="comment">//  发送当前时间（毫秒）给订阅者</span></div><div class="line">        <span class="keyword">char</span> <span class="built_in">string</span> [<span class="number">20</span>];</div><div class="line">        <span class="built_in">sprintf</span> (<span class="built_in">string</span>, <span class="string">"%"</span> PRId64, zclock_time ());</div><div class="line">        zstr_send (publisher, <span class="built_in">string</span>);</div><div class="line">        <span class="keyword">char</span> *signal = zstr_recv_nowait (pipe);</div><div class="line">        <span class="keyword">if</span> (signal) &#123;</div><div class="line">            <span class="built_in">free</span> (signal);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        zclock_sleep (<span class="number">1</span>);            <span class="comment">//  等待1毫秒</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  下面的代码会启动一个订阅者和一个发布者，当订阅者死亡时停止运行</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">zctx_t</span> *ctx = zctx_new ();</div><div class="line">    <span class="keyword">void</span> *pubpipe = zthread_fork (ctx, publisher, <span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">void</span> *subpipe = zthread_fork (ctx, subscriber, <span class="literal">NULL</span>);</div><div class="line">    <span class="built_in">free</span> (zstr_recv (subpipe));</div><div class="line">    zstr_send (pubpipe, <span class="string">"break"</span>);</div><div class="line">    zclock_sleep (<span class="number">100</span>);</div><div class="line">    zctx_destroy (&amp;ctx);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>几点说明：</p>
<ul>
<li>示例程序中的消息包含了系统当前的时间戳（毫秒）。在现实应用中，你应该使用时间戳作为消息头，并提供消息内容。</li>
<li>示例程序中的发布者和订阅者是同一个进程的两个线程。在现实应用中，他们应该是两个不同的进程。示例中这么做只是为了演示的方便</li>
</ul>
<h3 id="高速订阅者（黑箱模式）"><a href="#高速订阅者（黑箱模式）" class="headerlink" title="高速订阅者（黑箱模式）"></a>高速订阅者（黑箱模式）</h3><p>发布-订阅模式的一个典型应用场景是大规模分布式数据处理。如要处理从证券市场上收集到的数据，可以在证券交易系统上设置一个发布者，获取价格信息，并发送给一组订阅者。如果我们有很多订阅者，我们可以使用TCP。如果订阅者到达一定的量，那我们就应该使用可靠的广播协议，如pgm。</p>
<p>假设我们的发布者每秒产生10万条100个字节的消息。在剔除了不需要的市场信息后，这个比率还是比较合理的。现在我们需要记录一天的数据（8小时约有250GB），再将其传入一个模拟网络，即一组订阅者。虽然10万条数据对ZMQ来说很容易处理，但我们需要更高的速度。</p>
<p>假设我们有多台机器，一台做发布者，其他的做订阅者。这些机器都是8核的，发布者那台有12核。</p>
<p>在我们开始发布消息时，有两点需要注意：</p>
<ol>
<li>即便只是处理很少的数据，订阅者仍由可能跟不上发布者的速度；</li>
<li>当处理到6M/s的数据量时，发布者和订阅都有可能达到极限。</li>
</ol>
<p>首先，我们需要将订阅者设计为一种多线程的处理程序，这样我们就能在一个线程中读取消息，使用其他线程来处理消息。一般来说，我们对每种消息的处理方式都是不同的。这样一来，订阅者可以对收到的消息进行一次过滤，如根据头信息来判别。当消息满足某些条件，订阅者会将消息交给worker处理。用ZMQ的语言来说，订阅者会将消息转发给worker来处理。</p>
<p>这样一来，订阅者看上去就像是一个队列装置，我们可以用各种方式去连接队列装置和worker。如我们建立单向的通信，每个worker都是相同的，可以使用PUSH和PULL套接字，分发的工作就交给ZMQ吧。这是最简单也是最快速的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">                      +-----------+</div><div class="line">                      |           |</div><div class="line">                      | Publisher |</div><div class="line">                      |           |</div><div class="line">                      +-----------+</div><div class="line">                      |    PUB    |</div><div class="line">                      \-----+-----/</div><div class="line">                            |</div><div class="line">+---------------------------|---------------------------+</div><div class="line">:                           |                Fast box   :</div><div class="line">:                           v                           :</div><div class="line">:                     /-----------\                     :</div><div class="line">:                     |    SUB    |                     :</div><div class="line">:                     +-----------+                     :</div><div class="line">:                     |           |                     :</div><div class="line">:                     | Subscriber|                     :</div><div class="line">:                     |           |                     :</div><div class="line">:                     +-----------+                     :</div><div class="line">:                     |   PUSH    |                     :</div><div class="line">:                     \-----+-----/                     :</div><div class="line">:                           |                           :</div><div class="line">:                           |                           :</div><div class="line">:           /---------------+---------------\           :</div><div class="line">:           |               |               |           :</div><div class="line">:           v               v               v           :</div><div class="line">:     /-----------\   /-----------\   /-----------\     :</div><div class="line">:     |   PULL    |   |   PULL    |   |   PULL    |     :</div><div class="line">:     +-----------+   +-----------+   +-----------+     :</div><div class="line">:     |           |   |           |   |           |     :</div><div class="line">:     |  Worker   |   |  Worker   |   |  Worker   |     :</div><div class="line">:     |           |   |           |   |           |     :</div><div class="line">:     +-----------+   +-----------+   +-----------+     :</div><div class="line">:                                                       :</div><div class="line">+-------------------------------------------------------+</div><div class="line"></div><div class="line">         Figure # - Simple Black Box Pattern</div></pre></td></tr></table></figure>
<p>订阅者和发布者之间的通信使用TCP或PGM协议，订阅者和worker的通信由于是在同一个进程中完成的，所以使用inproc协议。</p>
<p>下面我们看看如何突破瓶颈。由于订阅者是单线程的，当它的CPU占用率达到100%时，它无法使用其他的核心。单线程程序总是会遇到瓶颈的，不管是2M、6M还是更多。我们需要将工作量分配到不同的线程中去，并发地执行。</p>
<p>很多高性能产品使用的方案是分片，就是将工作量拆分成独立并行的流。如，一半的专题数据由一个流媒体传输，另一半由另一个流媒体传输。我们可以建立更多的流媒体，但如果CPU核心数不变，那就没有必要了。<br>让我们看看如何将工作量分片为两个流：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">                      +-----------+</div><div class="line">                      |           |</div><div class="line">                      | Publisher |</div><div class="line">                      |           |</div><div class="line">                      +-----+-----+</div><div class="line">                      | PUB | PUB |</div><div class="line">                      \--+--+--+--/</div><div class="line">                         |     |</div><div class="line">+------------------------|--=--|------------------------+</div><div class="line">:                        |     |             Fast box   :</div><div class="line">:                        v     v                        :</div><div class="line">:                     /-----+-----\                     :</div><div class="line">:                     | SUB | SUB |                     :</div><div class="line">:                     +-----+-----+                     :</div><div class="line">:                     |           |                     :</div><div class="line">:                     | Subscriber|                     :</div><div class="line">:                     |           |                     :</div><div class="line">:                     +-----+-----+                     :</div><div class="line">:                     | PUSH|PUSH |                     :</div><div class="line">:                     \--+--+--+--/                     :</div><div class="line">:                        |     |                        :</div><div class="line">:                        |     |                        :</div><div class="line">:           /------------+--+  +------------\           :</div><div class="line">:           |               |               |           :</div><div class="line">:           v               v               v           :</div><div class="line">:     /-----------\   /-----------\   /-----------\     :</div><div class="line">:     |   PULL    |   |   PULL    |   |   PULL    |     :</div><div class="line">:     +-----------+   +-----------+   +-----------+     :</div><div class="line">:     |           |   |           |   |           |     :</div><div class="line">:     |  Worker   |   |  Worker   |   |  Worker   |     :</div><div class="line">:     |           |   |           |   |           |     :</div><div class="line">:     +-----------+   +-----------+   +-----------+     :</div><div class="line">:                                                       :</div><div class="line">+-------------------------------------------------------+</div><div class="line"></div><div class="line">            Figure # - Mad Black Box Pattern</div></pre></td></tr></table></figure>
<p>要让两个流全速工作，需要这样配置ZMQ：</p>
<ul>
<li>使用两个I/O线程，而不是一个；</li>
<li>使用两个独立的网络接口；</li>
<li>每个I/O线程绑定至一个网络接口；</li>
<li>两个订阅者线程，分别绑定至一个核心；</li>
<li>使用两个SUB套接字；</li>
<li>剩余的核心供worker使用；</li>
<li>worker线程同时绑定至两个订阅者线程的PUSH套接字。</li>
</ul>
<p>创建的线程数量应和CPU核心数一致，如果我们建立的线程数量超过核心数，那其处理速度只会减少。另外，开放多个I/O线程也是没有必要的。</p>
<h3 id="共享键值缓存（克隆模式）"><a href="#共享键值缓存（克隆模式）" class="headerlink" title="共享键值缓存（克隆模式）"></a>共享键值缓存（克隆模式）</h3><p>发布-订阅模式和无线电广播有些类似，在你收听之前发送的消息你将无从得知，收到消息的多少又会取决于你的接收能力。让人吃惊的是，对于那些追求完美的工程师来说，这种机器恰恰符合他们的需求，且广为传播，成为现实生活中分发消息的最佳机制。想想非死不可、推特、BBS新闻、体育新闻等应用就知道了。</p>
<p>但是，在很多情形下，可靠的发布-订阅模式同样是有价值的。正如我们讨论请求-应答模式一样，我们会根据“故障”来定义“可靠性”，下面几项便是发布-订阅模式中可能发生的故障：</p>
<ul>
<li>订阅者连接太慢，因此没有收到发布者最初发送的消息；</li>
<li>订阅者速度太慢，同样会丢失消息；</li>
<li>订阅者可能会断开，其间的消息也会丢失。</li>
</ul>
<p>还有一些情况我们碰到的比较少，但不是没有：</p>
<ul>
<li>订阅者崩溃、重启，从而丢失了所有已收到的消息；</li>
<li>订阅者处理消息的速度过慢，导致消息在队列中堆砌并溢出；</li>
<li>因网络过载而丢失消息（特别是PGM协议下的连接）；</li>
<li>网速过慢，消息在发布者处溢出，从而崩溃。</li>
</ul>
<p>其实还会有其他出错的情况，只是以上这些在现实应用中是比较典型的。</p>
<p>我们已经有方法解决上面的某些问题了，比如对于慢速订阅者可以使用自杀的蜗牛模式。但是，对于其他的问题，我们最后能有一个可复用的框架来编写可靠的发布-订阅模式。</p>
<p>难点在于，我们并不知道目标应用程序会怎样处理这些数据。它们会进行过滤、只处理一部分消息吗？它们是否会将消息记录起来供日后使用？它们是否会将消息转发给其下的worker进行处理？需要考虑的情况实在太多了，每种情况都有其所谓的可靠性。</p>
<p>所以，我们将问题抽象出来，供多种应用程序使用。这种抽象应用我们称之为共享的键值缓存，它的功能是通过唯一的键名存储二进制数据块。</p>
<p>不要将这个抽象应用和分布式哈希表混淆起来，它是用来解决节点在分布式网络中相连接的问题的；也不要和分布式键值表混淆，它更像是一个NoSQL数据库。我们要建立的应用是将内存中的状态可靠地传递给一组客户端，它要做到的是：</p>
<ul>
<li>客户端可以随时加入网络，并获得服务端当前的状态；</li>
<li>任何客户端都可以改变键值缓存（插入、更新、删除）；</li>
<li>将这种变化以最短的延迟可靠地传达给所有的客户端；</li>
<li>能够处理大量的客户端，成百上千。</li>
</ul>
<p>克隆模式的要点在于客户端会反过来和服务端进行通信，这在简单的发布-订阅模式中并不常见。所以我这里使用“服务端”、“客户端”而不是“发布者”、“订阅者”这两个词。我们会使用发布-订阅模式作为核心消息模式，不过还需要夹杂其他模式。</p>
<h4 id="分发键值更新事件"><a href="#分发键值更新事件" class="headerlink" title="分发键值更新事件"></a>分发键值更新事件</h4><p>我们会分阶段实施克隆模式。首先，我们看看如何从服务器发送键值更新事件给所有的客户端。我们将第一章中使用的天气服务模型进行改造，以键值对的方式发送信息，并让客户端使用哈希表来保存：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">               +-------------+</div><div class="line">               |             |</div><div class="line">               |   Server    |</div><div class="line">               |             |</div><div class="line">               +-------------+</div><div class="line">               |     PUB     |</div><div class="line">               \-------------/</div><div class="line">                      |</div><div class="line">                      |</div><div class="line">                   updates</div><div class="line">                      |</div><div class="line">      +---------------+---------------+</div><div class="line">      |               |               |</div><div class="line">      |               |               |</div><div class="line">      v               v               v</div><div class="line">/------------\  /------------\  /------------\</div><div class="line">|    SUB     |  |    SUB     |  |    SUB     |</div><div class="line">+------------+  +------------+  +------------+</div><div class="line">|            |  |            |  |            |</div><div class="line">|   Client   |  |   Client   |  |   Client   |</div><div class="line">|            |  |            |  |            |</div><div class="line">+------------+  +------------+  +------------+</div><div class="line"></div><div class="line"></div><div class="line">      Figure # - Simplest Clone Model</div></pre></td></tr></table></figure>
<p>以下是服务端代码：</p>
<p><strong>clonesrv1: Clone server, Model One in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  克隆模式服务端模型1</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="comment">//  让我们直接编译，不生成类库</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvsimple.c"</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//  准备上下文和PUB套接字</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx = zctx_new ();</div><div class="line">    <span class="keyword">void</span> *publisher = zsocket_new (ctx, ZMQ_PUB);</div><div class="line">    zsocket_bind (publisher, <span class="string">"tcp://*:5556"</span>);</div><div class="line">    zclock_sleep (<span class="number">200</span>);</div><div class="line"></div><div class="line">    <span class="keyword">zhash_t</span> *kvmap = zhash_new ();</div><div class="line">    <span class="keyword">int64_t</span> sequence = <span class="number">0</span>;</div><div class="line">    srandom ((<span class="keyword">unsigned</span>) time (<span class="literal">NULL</span>));</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (!zctx_interrupted) &#123;</div><div class="line">        <span class="comment">//  使用键值对分发消息</span></div><div class="line">        <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (++sequence);</div><div class="line">        kvmsg_fmt_key  (kvmsg, <span class="string">"%d"</span>, randof (<span class="number">10000</span>));</div><div class="line">        kvmsg_fmt_body (kvmsg, <span class="string">"%d"</span>, randof (<span class="number">1000000</span>));</div><div class="line">        kvmsg_send     (kvmsg, publisher);</div><div class="line">        kvmsg_store   (&amp;kvmsg, kvmap);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span> (<span class="string">" 已中止\n已发送 %d 条消息\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">    zhash_destroy (&amp;kvmap);</div><div class="line">    zctx_destroy (&amp;ctx);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以下是客户端代码：</p>
<p><strong>clonecli1: Clone client, Model One in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  克隆模式客户端模型1</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="comment">//  让我们直接编译，不生成类库</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvsimple.c"</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//  准备上下文和SUB套接字</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx = zctx_new ();</div><div class="line">    <span class="keyword">void</span> *updates = zsocket_new (ctx, ZMQ_SUB);</div><div class="line">    zsocket_connect (updates, <span class="string">"tcp://localhost:5556"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">zhash_t</span> *kvmap = zhash_new ();</div><div class="line">    <span class="keyword">int64_t</span> sequence = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (TRUE) &#123;</div><div class="line">        <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (updates);</div><div class="line">        <span class="keyword">if</span> (!kvmsg)</div><div class="line">            <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line">        kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line">        sequence++;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span> (<span class="string">" 已中断\n收到 %d 条消息\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">    zhash_destroy (&amp;kvmap);</div><div class="line">    zctx_destroy (&amp;ctx);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>几点说明：</p>
<ul>
<li>所有复杂的工作都在kvmsg类中完成了，这个类能够处理键值对类型的消息对象，其实质上是一个ZMQ多帧消息，共有三帧：键（ZMQ字符串）、编号（64位，按字节顺序排列）、二进制体（保存所有附加信息）。</li>
<li>服务端随机生成消息，使用四位数作为键，这样可以模拟大量而不是过量的哈希表（1万个条目）。</li>
<li>服务端绑定套接字后会等待200毫秒，以避免订阅者连接延迟而丢失数据的问题。我们会在后面的模型中解决这一点。</li>
<li>我们使用“发布者”和“订阅者”来命名程序中使用的套接字，这样可以避免和后续模型中的其他套接字发生混淆。</li>
</ul>
<p>以下是kvmsg的代码，已经经过了精简：<br><strong>kvsimple: Key-value message class in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*  =====================================================================</span></div><div class="line">    kvsimple - simple key-value message class for example applications</div><div class="line"></div><div class="line">    ---------------------------------------------------------------------</div><div class="line">    Copyright (c) 1991-2011 iMatix Corporation &lt;www.imatix.com&gt;</div><div class="line">    Copyright other contributors as noted in the AUTHORS file.</div><div class="line"></div><div class="line">    This file is part of the ZeroMQ Guide: http://zguide.zeromq.org</div><div class="line"></div><div class="line">    This is free software; you can redistribute it and/or modify it under</div><div class="line">    the terms of the GNU Lesser General Public License as published by</div><div class="line">    the Free Software Foundation; either version 3 of the License, or (at</div><div class="line">    your option) any later version.</div><div class="line"></div><div class="line">    This software is distributed in the hope that it will be useful, but</div><div class="line">    WITHOUT ANY WARRANTY; without even the implied warranty of</div><div class="line">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</div><div class="line">    Lesser General Public License for more details.</div><div class="line"></div><div class="line">    You should have received a copy of the GNU Lesser General Public</div><div class="line">    License along with this program. If not, see</div><div class="line">    &lt;http://www.gnu.org/licenses/&gt;.</div><div class="line">    =====================================================================</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvsimple.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"zlist.h"</span></span></div><div class="line"></div><div class="line"><span class="comment">//  键是一个短字符串</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KVMSG_KEY_MAX   255</span></div><div class="line"></div><div class="line"><span class="comment">//  消息被格式化成三帧</span></div><div class="line"><span class="comment">//  frame 0: 键（ZMQ字符串）</span></div><div class="line"><span class="comment">//  frame 1: 编号（8个字节，按顺序排列）</span></div><div class="line"><span class="comment">//  frame 2: 内容（二进制数据块）</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FRAME_KEY       0</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FRAME_SEQ       1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FRAME_BODY      2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KVMSG_FRAMES    3</span></div><div class="line"></div><div class="line"><span class="comment">//  类结构</span></div><div class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">kvmsg</span> &#123;</span></div><div class="line">    <span class="comment">//  消息中某帧是否存在</span></div><div class="line">    <span class="keyword">int</span> present [KVMSG_FRAMES];</div><div class="line">    <span class="comment">//  对应的ZMQ消息帧</span></div><div class="line">    <span class="keyword">zmq_msg_t</span> frame [KVMSG_FRAMES];</div><div class="line">    <span class="comment">//  将键转换为C语言字符串</span></div><div class="line">    <span class="keyword">char</span> key [KVMSG_KEY_MAX + <span class="number">1</span>];</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  构造函数，设置编号</span></div><div class="line"></div><div class="line"><span class="keyword">kvmsg_t</span> *</div><div class="line">kvmsg_new (<span class="keyword">int64_t</span> sequence)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">kvmsg_t</span></div><div class="line">        *self;</div><div class="line"></div><div class="line">    self = (<span class="keyword">kvmsg_t</span> *) zmalloc (<span class="keyword">sizeof</span> (<span class="keyword">kvmsg_t</span>));</div><div class="line">    kvmsg_set_sequence (self, sequence);</div><div class="line">    <span class="keyword">return</span> self;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  析构函数</span></div><div class="line"></div><div class="line"><span class="comment">//  释放消息中的帧，可供zhash_freefn()函数调用</span></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_free</span> <span class="params">(<span class="keyword">void</span> *ptr)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (ptr) &#123;</div><div class="line">        <span class="keyword">kvmsg_t</span> *self = (<span class="keyword">kvmsg_t</span> *) ptr;</div><div class="line">        <span class="comment">//  销毁消息中的帧</span></div><div class="line">        <span class="keyword">int</span> frame_nbr;</div><div class="line">        <span class="keyword">for</span> (frame_nbr = <span class="number">0</span>; frame_nbr &lt; KVMSG_FRAMES; frame_nbr++)</div><div class="line">            <span class="keyword">if</span> (self-&gt;present [frame_nbr])</div><div class="line">                zmq_msg_close (&amp;self-&gt;frame [frame_nbr]);</div><div class="line"></div><div class="line">        <span class="comment">//  释放对象本身</span></div><div class="line">        <span class="built_in">free</span> (self);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_destroy</span> <span class="params">(<span class="keyword">kvmsg_t</span> **self_p)</span></div><div class="line">&#123;</div><div class="line">    assert (self_p);</div><div class="line">    <span class="keyword">if</span> (*self_p) &#123;</div><div class="line">        kvmsg_free (*self_p);</div><div class="line">        *self_p = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  从套接字中读取键值消息，返回kvmsg实例</span></div><div class="line"></div><div class="line"><span class="keyword">kvmsg_t</span> *</div><div class="line">kvmsg_recv (<span class="keyword">void</span> *socket)</div><div class="line">&#123;</div><div class="line">    assert (socket);</div><div class="line">    <span class="keyword">kvmsg_t</span> *self = kvmsg_new (<span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">//  读取所有帧，出错则销毁对象</span></div><div class="line">    <span class="keyword">int</span> frame_nbr;</div><div class="line">    <span class="keyword">for</span> (frame_nbr = <span class="number">0</span>; frame_nbr &lt; KVMSG_FRAMES; frame_nbr++) &#123;</div><div class="line">        <span class="keyword">if</span> (self-&gt;present [frame_nbr])</div><div class="line">            zmq_msg_close (&amp;self-&gt;frame [frame_nbr]);</div><div class="line">        zmq_msg_init (&amp;self-&gt;frame [frame_nbr]);</div><div class="line">        self-&gt;present [frame_nbr] = <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (zmq_recvmsg (socket, &amp;self-&gt;frame [frame_nbr], <span class="number">0</span>) == <span class="number">-1</span>) &#123;</div><div class="line">            kvmsg_destroy (&amp;self);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  验证多帧消息</span></div><div class="line">        <span class="keyword">int</span> rcvmore = (frame_nbr &lt; KVMSG_FRAMES - <span class="number">1</span>)? <span class="number">1</span>: <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (zsockopt_rcvmore (socket) != rcvmore) &#123;</div><div class="line">            kvmsg_destroy (&amp;self);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> self;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  向套接字发送键值对消息，不检验消息帧的内容</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_send</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">void</span> *socket)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    assert (socket);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> frame_nbr;</div><div class="line">    <span class="keyword">for</span> (frame_nbr = <span class="number">0</span>; frame_nbr &lt; KVMSG_FRAMES; frame_nbr++) &#123;</div><div class="line">        <span class="keyword">zmq_msg_t</span> copy;</div><div class="line">        zmq_msg_init (&amp;copy);</div><div class="line">        <span class="keyword">if</span> (self-&gt;present [frame_nbr])</div><div class="line">            zmq_msg_copy (&amp;copy, &amp;self-&gt;frame [frame_nbr]);</div><div class="line">        zmq_sendmsg (socket, &amp;copy,</div><div class="line">            (frame_nbr &lt; KVMSG_FRAMES - <span class="number">1</span>)? ZMQ_SNDMORE: <span class="number">0</span>);</div><div class="line">        zmq_msg_close (&amp;copy);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  从消息中获取键值，不存在则返回NULL</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span> *</span></div><div class="line"><span class="title">kvmsg_key</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_KEY]) &#123;</div><div class="line">        <span class="keyword">if</span> (!*self-&gt;key) &#123;</div><div class="line">            <span class="keyword">size_t</span> size = zmq_msg_size (&amp;self-&gt;frame [FRAME_KEY]);</div><div class="line">            <span class="keyword">if</span> (size &gt; KVMSG_KEY_MAX)</div><div class="line">                size = KVMSG_KEY_MAX;</div><div class="line">            <span class="built_in">memcpy</span> (self-&gt;key,</div><div class="line">                zmq_msg_data (&amp;self-&gt;frame [FRAME_KEY]), size);</div><div class="line">            self-&gt;key [size] = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> self-&gt;key;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  返回消息的编号</span></div><div class="line"></div><div class="line"><span class="keyword">int64_t</span></div><div class="line">kvmsg_sequence (<span class="keyword">kvmsg_t</span> *self)</div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_SEQ]) &#123;</div><div class="line">        assert (zmq_msg_size (&amp;self-&gt;frame [FRAME_SEQ]) == <span class="number">8</span>);</div><div class="line">        byte *source = zmq_msg_data (&amp;self-&gt;frame [FRAME_SEQ]);</div><div class="line">        <span class="keyword">int64_t</span> sequence = ((<span class="keyword">int64_t</span>) (source [<span class="number">0</span>]) &lt;&lt; <span class="number">56</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">1</span>]) &lt;&lt; <span class="number">48</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">2</span>]) &lt;&lt; <span class="number">40</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">3</span>]) &lt;&lt; <span class="number">32</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">4</span>]) &lt;&lt; <span class="number">24</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">5</span>]) &lt;&lt; <span class="number">16</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">6</span>]) &lt;&lt; <span class="number">8</span>)</div><div class="line">                         +  (<span class="keyword">int64_t</span>) (source [<span class="number">7</span>]);</div><div class="line">        <span class="keyword">return</span> sequence;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  返回消息内容，不存在则返回NULL</span></div><div class="line"></div><div class="line"><span class="function">byte *</span></div><div class="line"><span class="title">kvmsg_body</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_BODY])</div><div class="line">        <span class="keyword">return</span> (byte *) zmq_msg_data (&amp;self-&gt;frame [FRAME_BODY]);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  返回消息内容的大小</span></div><div class="line"></div><div class="line"><span class="keyword">size_t</span></div><div class="line">kvmsg_size (<span class="keyword">kvmsg_t</span> *self)</div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_BODY])</div><div class="line">        <span class="keyword">return</span> zmq_msg_size (&amp;self-&gt;frame [FRAME_BODY]);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  设置消息的键</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_set_key</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">char</span> *key)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">zmq_msg_t</span> *msg = &amp;self-&gt;frame [FRAME_KEY];</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_KEY])</div><div class="line">        zmq_msg_close (msg);</div><div class="line">    zmq_msg_init_size (msg, <span class="built_in">strlen</span> (key));</div><div class="line">    <span class="built_in">memcpy</span> (zmq_msg_data (msg), key, <span class="built_in">strlen</span> (key));</div><div class="line">    self-&gt;present [FRAME_KEY] = <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  设置消息的编号</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_set_sequence</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">int64_t</span> sequence)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">zmq_msg_t</span> *msg = &amp;self-&gt;frame [FRAME_SEQ];</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_SEQ])</div><div class="line">        zmq_msg_close (msg);</div><div class="line">    zmq_msg_init_size (msg, <span class="number">8</span>);</div><div class="line"></div><div class="line">    byte *source = zmq_msg_data (msg);</div><div class="line">    source [<span class="number">0</span>] = (byte) ((sequence &gt;&gt; <span class="number">56</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">1</span>] = (byte) ((sequence &gt;&gt; <span class="number">48</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">2</span>] = (byte) ((sequence &gt;&gt; <span class="number">40</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">3</span>] = (byte) ((sequence &gt;&gt; <span class="number">32</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">4</span>] = (byte) ((sequence &gt;&gt; <span class="number">24</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">5</span>] = (byte) ((sequence &gt;&gt; <span class="number">16</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">6</span>] = (byte) ((sequence &gt;&gt; <span class="number">8</span>)  &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">7</span>] = (byte) ((sequence)       &amp; <span class="number">255</span>);</div><div class="line"></div><div class="line">    self-&gt;present [FRAME_SEQ] = <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  设置消息内容</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_set_body</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, byte *body, <span class="keyword">size_t</span> size)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">zmq_msg_t</span> *msg = &amp;self-&gt;frame [FRAME_BODY];</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_BODY])</div><div class="line">        zmq_msg_close (msg);</div><div class="line">    self-&gt;present [FRAME_BODY] = <span class="number">1</span>;</div><div class="line">    zmq_msg_init_size (msg, size);</div><div class="line">    <span class="built_in">memcpy</span> (zmq_msg_data (msg), body, size);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  使用printf()格式设置消息键</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_fmt_key</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">char</span> *format, ...)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> value [KVMSG_KEY_MAX + <span class="number">1</span>];</div><div class="line">    va_list args;</div><div class="line"></div><div class="line">    assert (self);</div><div class="line">    va_start (args, format);</div><div class="line">    vsnprintf (value, KVMSG_KEY_MAX, format, args);</div><div class="line">    va_end (args);</div><div class="line">    kvmsg_set_key (self, value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  使用springf()格式设置消息内容</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_fmt_body</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">char</span> *format, ...)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> value [<span class="number">255</span> + <span class="number">1</span>];</div><div class="line">    va_list args;</div><div class="line"></div><div class="line">    assert (self);</div><div class="line">    va_start (args, format);</div><div class="line">    vsnprintf (value, <span class="number">255</span>, format, args);</div><div class="line">    va_end (args);</div><div class="line">    kvmsg_set_body (self, (byte *) value, <span class="built_in">strlen</span> (value));</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  若kvmsg结构的键值均存在，则存入哈希表；</span></div><div class="line"><span class="comment">//  如果kvmsg结构已没有引用，则自动销毁和释放。</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_store</span> <span class="params">(<span class="keyword">kvmsg_t</span> **self_p, <span class="keyword">zhash_t</span> *hash)</span></div><div class="line">&#123;</div><div class="line">    assert (self_p);</div><div class="line">    <span class="keyword">if</span> (*self_p) &#123;</div><div class="line">        <span class="keyword">kvmsg_t</span> *self = *self_p;</div><div class="line">        assert (self);</div><div class="line">        <span class="keyword">if</span> (self-&gt;present [FRAME_KEY]</div><div class="line">        &amp;&amp;  self-&gt;present [FRAME_BODY]) &#123;</div><div class="line">            zhash_update (hash, kvmsg_key (self), self);</div><div class="line">            zhash_freefn (hash, kvmsg_key (self), kvmsg_free);</div><div class="line">        &#125;</div><div class="line">        *self_p = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  将消息内容打印至标准错误输出，用以调试和跟踪</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_dump</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (self) &#123;</div><div class="line">        <span class="keyword">if</span> (!self) &#123;</div><div class="line">            <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"NULL"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">size_t</span> size = kvmsg_size (self);</div><div class="line">        byte  *body = kvmsg_body (self);</div><div class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"[seq:%"</span> PRId64 <span class="string">"]"</span>, kvmsg_sequence (self));</div><div class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"[key:%s]"</span>, kvmsg_key (self));</div><div class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"[size:%zd] "</span>, size);</div><div class="line">        <span class="keyword">int</span> char_nbr;</div><div class="line">        <span class="keyword">for</span> (char_nbr = <span class="number">0</span>; char_nbr &lt; size; char_nbr++)</div><div class="line">            <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"%02X"</span>, body [char_nbr]);</div><div class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"\n"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"NULL message\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  测试用例</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span></span></div><div class="line"><span class="title">kvmsg_test</span> <span class="params">(<span class="keyword">int</span> verbose)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">kvmsg_t</span></div><div class="line">        *kvmsg;</div><div class="line"></div><div class="line">    <span class="built_in">printf</span> (<span class="string">" * kvmsg: "</span>);</div><div class="line"></div><div class="line">    <span class="comment">//  准备上下文和套接字</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx = zctx_new ();</div><div class="line">    <span class="keyword">void</span> *output = zsocket_new (ctx, ZMQ_DEALER);</div><div class="line">    <span class="keyword">int</span> rc = zmq_bind (output, <span class="string">"ipc://kvmsg_selftest.ipc"</span>);</div><div class="line">    assert (rc == <span class="number">0</span>);</div><div class="line">    <span class="keyword">void</span> *input = zsocket_new (ctx, ZMQ_DEALER);</div><div class="line">    rc = zmq_connect (input, <span class="string">"ipc://kvmsg_selftest.ipc"</span>);</div><div class="line">    assert (rc == <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">zhash_t</span> *kvmap = zhash_new ();</div><div class="line"></div><div class="line">    <span class="comment">//  测试简单消息的发送和接受</span></div><div class="line">    kvmsg = kvmsg_new (<span class="number">1</span>);</div><div class="line">    kvmsg_set_key  (kvmsg, <span class="string">"key"</span>);</div><div class="line">    kvmsg_set_body (kvmsg, (byte *) <span class="string">"body"</span>, <span class="number">4</span>);</div><div class="line">    <span class="keyword">if</span> (verbose)</div><div class="line">        kvmsg_dump (kvmsg);</div><div class="line">    kvmsg_send (kvmsg, output);</div><div class="line">    kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line"></div><div class="line">    kvmsg = kvmsg_recv (input);</div><div class="line">    <span class="keyword">if</span> (verbose)</div><div class="line">        kvmsg_dump (kvmsg);</div><div class="line">    assert (streq (kvmsg_key (kvmsg), <span class="string">"key"</span>));</div><div class="line">    kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line"></div><div class="line">    <span class="comment">//  关闭并销毁所有对象</span></div><div class="line">    zhash_destroy (&amp;kvmap);</div><div class="line">    zctx_destroy (&amp;ctx);</div><div class="line"></div><div class="line">    <span class="built_in">printf</span> (<span class="string">"OK\n"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们会在下文编写一个更为完整的kvmsg类，可以用到现实环境中。</p>
<p>客户端和服务端都会维护一个哈希表，但这个模型需要所有的客户端都比服务端启动得早，而且不能崩溃，这显然不能满足可靠性的要求。</p>
<h4 id="创建快照"><a href="#创建快照" class="headerlink" title="创建快照"></a>创建快照</h4><p>为了让后续连接的（或从故障中恢复的）客户端能够获取服务器上的状态信息，需要让它在连接时获取一份快照。正如我们将“消息”的概念简化为“已编号的键值对”，我们也可以将“状态”简化为“一个哈希表”。为获取服务端状态，客户端会打开一个REQ套接字进行请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">               +-----------------+</div><div class="line">               |                 |</div><div class="line">               |     Server      |</div><div class="line">               |                 |</div><div class="line">               +--------+--------+</div><div class="line">               |   PUB  | ROUTER |</div><div class="line">               \----+---+--------/</div><div class="line">                    |       ^</div><div class="line">                    |       | state request</div><div class="line">                 updates    +---------------\</div><div class="line">                    |                       |</div><div class="line">   /----------------+----------------\      |</div><div class="line">   |                |                |      |</div><div class="line">   |                |                |      |</div><div class="line">   v                v                v      |</div><div class="line">/------+-----\   /------+-----\   /------+--+--\</div><div class="line">| SUB  | REQ |   | SUB  | REQ |   | SUB  | REQ |</div><div class="line">+------+-----+   +------+-----+   +------+-----+</div><div class="line">|            |   |            |   |            |</div><div class="line">|   Client   |   |   Client   |   |   Client   |</div><div class="line">|            |   |            |   |            |</div><div class="line">+------------+   +------------+   +------------+</div><div class="line"></div><div class="line"></div><div class="line">        Figure # - State Replication</div></pre></td></tr></table></figure>
<p>我们需要考虑时间的问题，因为生成快照是需要一定时间的，我们需要知道应从哪个更新事件开始更新快照，服务端是不知道何时有更新事件的。一种方法是先开始订阅消息，收到第一个消息之后向服务端请求“将该条更新之前的所有内容发送给”。这样一来，服务器需要为每一次更新保存一份快照，这显然是不现实的。</p>
<p>所以，我们会在客户端用以下方式进行同步：</p>
<ul>
<li><p>客户端开始订阅服务器的更新事件，然后请求一份快照。这样就能保证这份快照是在上一次更新事件之后产生的。</p>
</li>
<li><p>客户端开始等待服务器的快照，并将更新事件保存在队列中，做法很简单，不要从套接字中读取消息就可以了，ZMQ会自动将这些消息保存起来，这时不应设置阈值（HWM）。</p>
</li>
<li><p>当客户端获取到快照后，它将再次开始读取更新事件，但是需要丢弃那些早于快照生成时间的事件。如快照生成时包含了200次更新，那客户端会从第201次更新开始读取。</p>
</li>
<li><p>随后，客户端就会用更新事件去更新自身的状态了。</p>
</li>
</ul>
<p>这是一个比较简单的模型，因为它用到了ZMQ消息队列的机制。服务端代码如下：</p>
<p><strong>clonesrv2: Clone server, Model Two in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  克隆模式 - 服务端 - 模型2</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="comment">//  让我们直接编译，不创建类库</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvsimple.c"</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_send_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">state_manager</span> <span class="params">(<span class="keyword">void</span> *args, <span class="keyword">zctx_t</span> *ctx, <span class="keyword">void</span> *pipe)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//  准备套接字和上下文</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx = zctx_new ();</div><div class="line">    <span class="keyword">void</span> *publisher = zsocket_new (ctx, ZMQ_PUB);</div><div class="line">    zsocket_bind (publisher, <span class="string">"tcp://*:5557"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int64_t</span> sequence = <span class="number">0</span>;</div><div class="line">    srandom ((<span class="keyword">unsigned</span>) time (<span class="literal">NULL</span>));</div><div class="line"></div><div class="line">    <span class="comment">//  开启状态管理器，并等待同步信号</span></div><div class="line">    <span class="keyword">void</span> *updates = zthread_fork (ctx, state_manager, <span class="literal">NULL</span>);</div><div class="line">    <span class="built_in">free</span> (zstr_recv (updates));</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (!zctx_interrupted) &#123;</div><div class="line">        <span class="comment">//  分发键值消息</span></div><div class="line">        <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (++sequence);</div><div class="line">        kvmsg_fmt_key  (kvmsg, <span class="string">"%d"</span>, randof (<span class="number">10000</span>));</div><div class="line">        kvmsg_fmt_body (kvmsg, <span class="string">"%d"</span>, randof (<span class="number">1000000</span>));</div><div class="line">        kvmsg_send     (kvmsg, publisher);</div><div class="line">        kvmsg_send     (kvmsg, updates);</div><div class="line">        kvmsg_destroy (&amp;kvmsg);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span> (<span class="string">" 已中断\n已发送 %d 条消息\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">    zctx_destroy (&amp;ctx);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  快照请求方信息</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    <span class="keyword">void</span> *socket;           <span class="comment">//  用于发送快照的ROUTER套接字</span></div><div class="line">    <span class="keyword">zframe_t</span> *identity;     <span class="comment">//  请求方的标识</span></div><div class="line">&#125; <span class="keyword">kvroute_t</span>;</div><div class="line"></div><div class="line"><span class="comment">//  发送快照中单个键值对</span></div><div class="line"><span class="comment">//  使用kvmsg对象作为载体</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_send_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">kvroute_t</span> *kvroute = (<span class="keyword">kvroute_t</span> *) args;</div><div class="line">    <span class="comment">//  先发送接收方标识</span></div><div class="line">    zframe_send (&amp;kvroute-&gt;identity,</div><div class="line">        kvroute-&gt;socket, ZFRAME_MORE + ZFRAME_REUSE);</div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = (<span class="keyword">kvmsg_t</span> *) data;</div><div class="line">    kvmsg_send (kvmsg, kvroute-&gt;socket);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  该线程维护服务端状态，并处理快照请求。</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">state_manager</span> <span class="params">(<span class="keyword">void</span> *args, <span class="keyword">zctx_t</span> *ctx, <span class="keyword">void</span> *pipe)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">zhash_t</span> *kvmap = zhash_new ();</div><div class="line"></div><div class="line">    zstr_send (pipe, <span class="string">"READY"</span>);</div><div class="line">    <span class="keyword">void</span> *snapshot = zsocket_new (ctx, ZMQ_ROUTER);</div><div class="line">    zsocket_bind (snapshot, <span class="string">"tcp://*:5556"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">zmq_pollitem_t</span> items [] = &#123;</div><div class="line">        &#123; pipe, <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125;,</div><div class="line">        &#123; snapshot, <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">int64_t</span> sequence = <span class="number">0</span>;       <span class="comment">//  当前快照版本</span></div><div class="line">    <span class="keyword">while</span> (!zctx_interrupted) &#123;</div><div class="line">        <span class="keyword">int</span> rc = zmq_poll (items, <span class="number">2</span>, <span class="number">-1</span>);</div><div class="line">        <span class="keyword">if</span> (rc == <span class="number">-1</span> &amp;&amp; errno == ETERM)</div><div class="line">            <span class="keyword">break</span>;              <span class="comment">//  上下文异常</span></div><div class="line"></div><div class="line">        <span class="comment">//  等待主线程的更新事件</span></div><div class="line">        <span class="keyword">if</span> (items [<span class="number">0</span>].revents &amp; ZMQ_POLLIN) &#123;</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (pipe);</div><div class="line">            <span class="keyword">if</span> (!kvmsg)</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line">            sequence = kvmsg_sequence (kvmsg);</div><div class="line">            kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  执行快照请求</span></div><div class="line">        <span class="keyword">if</span> (items [<span class="number">1</span>].revents &amp; ZMQ_POLLIN) &#123;</div><div class="line">            <span class="keyword">zframe_t</span> *identity = zframe_recv (snapshot);</div><div class="line">            <span class="keyword">if</span> (!identity)</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line"></div><div class="line">            <span class="comment">//  请求内容在第二帧中</span></div><div class="line">            <span class="keyword">char</span> *request = zstr_recv (snapshot);</div><div class="line">            <span class="keyword">if</span> (streq (request, <span class="string">"ICANHAZ?"</span>))</div><div class="line">                <span class="built_in">free</span> (request);</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">printf</span> (<span class="string">"E: 错误的请求，程序中止\n"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//  发送快照给客户端</span></div><div class="line">            <span class="keyword">kvroute_t</span> routing = &#123; snapshot, identity &#125;;</div><div class="line"></div><div class="line">            <span class="comment">//  逐项发送</span></div><div class="line">            zhash_foreach (kvmap, s_send_single, &amp;routing);</div><div class="line"></div><div class="line">            <span class="comment">//  发送结束标识，内含快照版本号</span></div><div class="line">            <span class="built_in">printf</span> (<span class="string">"正在发送快照，版本号 %d\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">            zframe_send (&amp;identity, snapshot, ZFRAME_MORE);</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (sequence);</div><div class="line">            kvmsg_set_key  (kvmsg, <span class="string">"KTHXBAI"</span>);</div><div class="line">            kvmsg_set_body (kvmsg, (byte *) <span class="string">""</span>, <span class="number">0</span>);</div><div class="line">            kvmsg_send     (kvmsg, snapshot);</div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    zhash_destroy (&amp;kvmap);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以下是客户端代码：</p>
<p><strong>clonecli2: Clone client, Model Two in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// 克隆模式 - 客户端 - 模型2</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="comment">//  让我们直接编译，不生成类库</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvsimple.c"</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//  准备上下文和SUB套接字</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx = zctx_new ();</div><div class="line">    <span class="keyword">void</span> *snapshot = zsocket_new (ctx, ZMQ_DEALER);</div><div class="line">    zsocket_connect (snapshot, <span class="string">"tcp://localhost:5556"</span>);</div><div class="line">    <span class="keyword">void</span> *subscriber = zsocket_new (ctx, ZMQ_SUB);</div><div class="line">    zsocket_connect (subscriber, <span class="string">"tcp://localhost:5557"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">zhash_t</span> *kvmap = zhash_new ();</div><div class="line"></div><div class="line">    <span class="comment">//  获取快照</span></div><div class="line">    <span class="keyword">int64_t</span> sequence = <span class="number">0</span>;</div><div class="line">    zstr_send (snapshot, <span class="string">"ICANHAZ?"</span>);</div><div class="line">    <span class="keyword">while</span> (TRUE) &#123;</div><div class="line">        <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (snapshot);</div><div class="line">        <span class="keyword">if</span> (!kvmsg)</div><div class="line">            <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line">        <span class="keyword">if</span> (streq (kvmsg_key (kvmsg), <span class="string">"KTHXBAI"</span>)) &#123;</div><div class="line">            sequence = kvmsg_sequence (kvmsg);</div><div class="line">            <span class="built_in">printf</span> (<span class="string">"已获取快照，版本号=%d\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">            <span class="keyword">break</span>;          <span class="comment">//  完成</span></div><div class="line">        &#125;</div><div class="line">        kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//  应用队列中的更新事件，丢弃过时事件</span></div><div class="line">    <span class="keyword">while</span> (!zctx_interrupted) &#123;</div><div class="line">        <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (subscriber);</div><div class="line">        <span class="keyword">if</span> (!kvmsg)</div><div class="line">            <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line">        <span class="keyword">if</span> (kvmsg_sequence (kvmsg) &gt; sequence) &#123;</div><div class="line">            sequence = kvmsg_sequence (kvmsg);</div><div class="line">            kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">    &#125;</div><div class="line">    zhash_destroy (&amp;kvmap);</div><div class="line">    zctx_destroy (&amp;ctx);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>几点说明：</p>
<ul>
<li><p>客户端使用两个线程，一个用来生成随机的更新事件，另一个用来管理状态。两者之间使用PAIR套接字通信。可能你会考虑使用SUB套接字，但是“慢连接”的问题会影响到程序运行。PAIR套接字会让两个线程严格同步的。</p>
</li>
<li><p>我们在updates套接字上设置了阈值（HWM），避免更新服务内存溢出。在inproc协议的连接中，阈值是两端套接字阈值的加和，所以要分别设置。</p>
</li>
<li><p>客户端比较简单，用C语言编写，大约60行代码。大多数工作都在kvmsg类中完成了，不过总的来说，克隆模式实现起来还是比较简单的。</p>
</li>
<li><p>我们没有用特别的方式来序列化状态内容。键值对用kvmsg对象表示，保存在一个哈希表中。在不同的时间请求状态时会得到不同的快照。</p>
</li>
<li><p>我们假设客户端只和一个服务进行通信，而且服务必须是正常运行的。我们暂不考虑如何从服务崩溃的情形中恢复过来。</p>
</li>
</ul>
<p>现在，这两段程序都还没有真正地工作起来，但已经能够正确地同步状态了。这是一个多种消息模式的混合体：进程内的PAIR、发布-订阅、ROUTER-DEALER等。</p>
<h4 id="重发键值更新事件"><a href="#重发键值更新事件" class="headerlink" title="重发键值更新事件"></a>重发键值更新事件</h4><p>第二个模型中，键值更新事件都来自于服务器，构成了一个中心化的模型。但是我们需要的是一个能够在客户端进行更新的缓存，并能同步到其他客户端中。这时，服务端只是一个无状态的中间件，带来的好处有：</p>
<ul>
<li>我们不用太过关心服务端的可靠性，因为即使它崩溃了，我们仍能从客户端中获取完整的数据。</li>
<li>我们可以使用键值缓存在动态节点之间分享数据。</li>
</ul>
<p>客户端的键值更新事件会通过PUSH-PULL套接字传达给服务端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">          +--------------------------+</div><div class="line">          |                          |</div><div class="line">          |          Server          |</div><div class="line">          |                          |</div><div class="line">          +--------+--------+--------+</div><div class="line">          |   PUB  | ROUTER |  PULL  |</div><div class="line">          \----+---+--------+--------/</div><div class="line">               |       ^        ^</div><div class="line">               |       |        | state update</div><div class="line">               |       |        \---------\</div><div class="line">               |       | state request    |</div><div class="line">            updates    \------------\     |</div><div class="line">               |                    |     |</div><div class="line">   /-----------+-------------\      |     |</div><div class="line">   |                         |      |     |</div><div class="line">   |      ^     ^            |      |     |</div><div class="line">   v      |     |            v      |     |</div><div class="line">/------+--+--+--+---\     /------+--+--+--+---\</div><div class="line">| SUB  | REQ | PUSH |     | SUB  | REQ | PUSH |</div><div class="line">+------+-----+------+     +------+-----+------+</div><div class="line">|                   |     |                   |</div><div class="line">|       Client      |     |       Client      |</div><div class="line">|                   |     |                   |</div><div class="line">+-------------------+     +-------------------+</div><div class="line"></div><div class="line"></div><div class="line">       Figure # - Republishing Updates</div></pre></td></tr></table></figure>
<p>我们为什么不让客户端直接将更新信息发送给其他客户端呢？虽然这样做可以减少延迟，但是就无法为更新事件添加自增的唯一编号了。很多应用程序都需要更新事件以某种方式排序，只有将消息发给服务端，由服务端分发更新消息，才能保证更新事件的顺序。</p>
<p>有了唯一的编号后，客户端还能检测到更多的故障：网络堵塞或队列溢出。如果客户端发现消息输入流有一段空白，它能采取措施。可能你会觉得此时让客户端通知服务端，让它重新发送丢失的信息，可以解决问题。但事实上没有必要这么做。消息流的空挡表示网络状况不好，如果再进行这样的请求，只会让事情变得更糟。所以一般的做法是由客户端发出警告，并停止运行，等到有专人来维护后再继续工作。<br>我们开始创建在客户端进行状态更新的模型。以下是客户端代码：</p>
<p><strong>clonesrv3: Clone server, Model Three in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  克隆模式 服务端 模型3</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="comment">//  直接编译，不创建类库</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvsimple.c"</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_send_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">//  快照请求方信息</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    <span class="keyword">void</span> *socket;           <span class="comment">//  ROUTER套接字</span></div><div class="line">    <span class="keyword">zframe_t</span> *identity;     <span class="comment">//  请求方标识</span></div><div class="line">&#125; <span class="keyword">kvroute_t</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//  准备上下文和套接字</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx = zctx_new ();</div><div class="line">    <span class="keyword">void</span> *snapshot = zsocket_new (ctx, ZMQ_ROUTER);</div><div class="line">    zsocket_bind (snapshot, <span class="string">"tcp://*:5556"</span>);</div><div class="line">    <span class="keyword">void</span> *publisher = zsocket_new (ctx, ZMQ_PUB);</div><div class="line">    zsocket_bind (publisher, <span class="string">"tcp://*:5557"</span>);</div><div class="line">    <span class="keyword">void</span> *collector = zsocket_new (ctx, ZMQ_PULL);</div><div class="line">    zsocket_bind (collector, <span class="string">"tcp://*:5558"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int64_t</span> sequence = <span class="number">0</span>;</div><div class="line">    <span class="keyword">zhash_t</span> *kvmap = zhash_new ();</div><div class="line"></div><div class="line">    <span class="keyword">zmq_pollitem_t</span> items [] = &#123;</div><div class="line">        &#123; collector, <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125;,</div><div class="line">        &#123; snapshot, <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">while</span> (!zctx_interrupted) &#123;</div><div class="line">        <span class="keyword">int</span> rc = zmq_poll (items, <span class="number">2</span>, <span class="number">1000</span> * ZMQ_POLL_MSEC);</div><div class="line"></div><div class="line">        <span class="comment">//  执行来自客户端的更新事件</span></div><div class="line">        <span class="keyword">if</span> (items [<span class="number">0</span>].revents &amp; ZMQ_POLLIN) &#123;</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (collector);</div><div class="line">            <span class="keyword">if</span> (!kvmsg)</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line">            kvmsg_set_sequence (kvmsg, ++sequence);</div><div class="line">            kvmsg_send (kvmsg, publisher);</div><div class="line">            kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line">            <span class="built_in">printf</span> (<span class="string">"I: 发布更新事件 %5d\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  响应快照请求</span></div><div class="line">        <span class="keyword">if</span> (items [<span class="number">1</span>].revents &amp; ZMQ_POLLIN) &#123;</div><div class="line">            <span class="keyword">zframe_t</span> *identity = zframe_recv (snapshot);</div><div class="line">            <span class="keyword">if</span> (!identity)</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line"></div><div class="line">            <span class="comment">//  请求内容在消息的第二帧中</span></div><div class="line">            <span class="keyword">char</span> *request = zstr_recv (snapshot);</div><div class="line">            <span class="keyword">if</span> (streq (request, <span class="string">"ICANHAZ?"</span>))</div><div class="line">                <span class="built_in">free</span> (request);</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">printf</span> (<span class="string">"E: 错误的请求，程序中止\n"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//  发送快照</span></div><div class="line">            <span class="keyword">kvroute_t</span> routing = &#123; snapshot, identity &#125;;</div><div class="line"></div><div class="line">            <span class="comment">//  逐条发送</span></div><div class="line">            zhash_foreach (kvmap, s_send_single, &amp;routing);</div><div class="line"></div><div class="line">            <span class="comment">//  发送结束标识和编号</span></div><div class="line">            <span class="built_in">printf</span> (<span class="string">"I: 正在发送快照，版本号：%d\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">            zframe_send (&amp;identity, snapshot, ZFRAME_MORE);</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (sequence);</div><div class="line">            kvmsg_set_key  (kvmsg, <span class="string">"KTHXBAI"</span>);</div><div class="line">            kvmsg_set_body (kvmsg, (byte *) <span class="string">""</span>, <span class="number">0</span>);</div><div class="line">            kvmsg_send     (kvmsg, snapshot);</div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span> (<span class="string">" 已中断\n已处理 %d 条消息\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">    zhash_destroy (&amp;kvmap);</div><div class="line">    zctx_destroy (&amp;ctx);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  发送一条键值对状态给套接字，使用kvmsg对象保存键值对</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_send_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">kvroute_t</span> *kvroute = (<span class="keyword">kvroute_t</span> *) args;</div><div class="line">    <span class="comment">//  Send identity of recipient first</span></div><div class="line">    zframe_send (&amp;kvroute-&gt;identity,</div><div class="line">        kvroute-&gt;socket, ZFRAME_MORE + ZFRAME_REUSE);</div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = (<span class="keyword">kvmsg_t</span> *) data;</div><div class="line">    kvmsg_send (kvmsg, kvroute-&gt;socket);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以下是客户端代码：</p>
<p><strong>clonecli3: Clone client, Model Three in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  克隆模式 - 客户端 - 模型3</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="comment">//  直接编译，不创建类库</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvsimple.c"</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//  准备上下文和SUB套接字</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx = zctx_new ();</div><div class="line">    <span class="keyword">void</span> *snapshot = zsocket_new (ctx, ZMQ_DEALER);</div><div class="line">    zsocket_connect (snapshot, <span class="string">"tcp://localhost:5556"</span>);</div><div class="line">    <span class="keyword">void</span> *subscriber = zsocket_new (ctx, ZMQ_SUB);</div><div class="line">    zsocket_connect (subscriber, <span class="string">"tcp://localhost:5557"</span>);</div><div class="line">    <span class="keyword">void</span> *publisher = zsocket_new (ctx, ZMQ_PUSH);</div><div class="line">    zsocket_connect (publisher, <span class="string">"tcp://localhost:5558"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">zhash_t</span> *kvmap = zhash_new ();</div><div class="line">    srandom ((<span class="keyword">unsigned</span>) time (<span class="literal">NULL</span>));</div><div class="line"></div><div class="line">    <span class="comment">//  获取状态快照</span></div><div class="line">    <span class="keyword">int64_t</span> sequence = <span class="number">0</span>;</div><div class="line">    zstr_send (snapshot, <span class="string">"ICANHAZ?"</span>);</div><div class="line">    <span class="keyword">while</span> (TRUE) &#123;</div><div class="line">        <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (snapshot);</div><div class="line">        <span class="keyword">if</span> (!kvmsg)</div><div class="line">            <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line">        <span class="keyword">if</span> (streq (kvmsg_key (kvmsg), <span class="string">"KTHXBAI"</span>)) &#123;</div><div class="line">            sequence = kvmsg_sequence (kvmsg);</div><div class="line">            <span class="built_in">printf</span> (<span class="string">"I: 已收到快照，版本号：%d\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">            <span class="keyword">break</span>;          <span class="comment">//  完成</span></div><div class="line">        &#125;</div><div class="line">        kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int64_t</span> alarm = zclock_time () + <span class="number">1000</span>;</div><div class="line">    <span class="keyword">while</span> (!zctx_interrupted) &#123;</div><div class="line">        <span class="keyword">zmq_pollitem_t</span> items [] = &#123; &#123; subscriber, <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125; &#125;;</div><div class="line">        <span class="keyword">int</span> tickless = (<span class="keyword">int</span>) ((alarm - zclock_time ()));</div><div class="line">        <span class="keyword">if</span> (tickless &lt; <span class="number">0</span>)</div><div class="line">            tickless = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> rc = zmq_poll (items, <span class="number">1</span>, tickless * ZMQ_POLL_MSEC);</div><div class="line">        <span class="keyword">if</span> (rc == <span class="number">-1</span>)</div><div class="line">            <span class="keyword">break</span>;              <span class="comment">//  上下文被关闭</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (items [<span class="number">0</span>].revents &amp; ZMQ_POLLIN) &#123;</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (subscriber);</div><div class="line">            <span class="keyword">if</span> (!kvmsg)</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line"></div><div class="line">            <span class="comment">//  丢弃过时消息，包括心跳</span></div><div class="line">            <span class="keyword">if</span> (kvmsg_sequence (kvmsg) &gt; sequence) &#123;</div><div class="line">                sequence = kvmsg_sequence (kvmsg);</div><div class="line">                kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line">                <span class="built_in">printf</span> (<span class="string">"I: 收到更新事件：%d\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                kvmsg_destroy (&amp;kvmsg);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  创建一个随机的更新事件</span></div><div class="line">        <span class="keyword">if</span> (zclock_time () &gt;= alarm) &#123;</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (<span class="number">0</span>);</div><div class="line">            kvmsg_fmt_key  (kvmsg, <span class="string">"%d"</span>, randof (<span class="number">10000</span>));</div><div class="line">            kvmsg_fmt_body (kvmsg, <span class="string">"%d"</span>, randof (<span class="number">1000000</span>));</div><div class="line">            kvmsg_send     (kvmsg, publisher);</div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">            alarm = zclock_time () + <span class="number">1000</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span> (<span class="string">" 已准备\n收到 %d 条消息\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">    zhash_destroy (&amp;kvmap);</div><div class="line">    zctx_destroy (&amp;ctx);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>几点说明：</p>
<ul>
<li><p>服务端整合为一个线程，负责收集来自客户端的更新事件并转发给其他客户端。它使用PULL套接字获取更新事件，ROUTER套接字处理快照请求，以及PUB套接字发布更新事件。</p>
</li>
<li><p>客户端会每隔1秒左右发送随机的更新事件给服务端，现实中这一动作由应用程序触发。</p>
</li>
</ul>
<h4 id="子树克隆"><a href="#子树克隆" class="headerlink" title="子树克隆"></a>子树克隆</h4><p>现实中的键值缓存会越变越变，而客户端可能只会需要部分缓存。我们可以使用子树的方式来实现：客户端在发送快照请求时告诉服务端它需要的子树，在订阅更新事件事也指明子树。</p>
<p>关于子树的语法有很多，一种是“分层路径”结构，另一种是“主题树”：</p>
<ul>
<li>分层路径：/some/list/of/paths<ul>
<li>主题树：some.list.of.topics</li>
</ul>
</li>
</ul>
<p>这里我们会使用分层路径结构，以此扩展服务端和客户端，进行子树操作。维护多个子树其实并不太困难，因此我们不在这里演示。</p>
<p>下面是服务端代码，由模型3衍化而来：</p>
<p><strong>clonesrv4: Clone server, Model Four in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  克隆模式 服务端 模型4</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="comment">//  直接编译，不创建类库</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvsimple.c"</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_send_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">//  快照请求方信息</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    <span class="keyword">void</span> *socket;           <span class="comment">//  ROUTER套接字</span></div><div class="line">    <span class="keyword">zframe_t</span> *identity;     <span class="comment">//  请求方标识</span></div><div class="line">    <span class="keyword">char</span> *subtree;          <span class="comment">//  指定的子树</span></div><div class="line">&#125; <span class="keyword">kvroute_t</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//  准备上下文和套接字</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx = zctx_new ();</div><div class="line">    <span class="keyword">void</span> *snapshot = zsocket_new (ctx, ZMQ_ROUTER);</div><div class="line">    zsocket_bind (snapshot, <span class="string">"tcp://*:5556"</span>);</div><div class="line">    <span class="keyword">void</span> *publisher = zsocket_new (ctx, ZMQ_PUB);</div><div class="line">    zsocket_bind (publisher, <span class="string">"tcp://*:5557"</span>);</div><div class="line">    <span class="keyword">void</span> *collector = zsocket_new (ctx, ZMQ_PULL);</div><div class="line">    zsocket_bind (collector, <span class="string">"tcp://*:5558"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int64_t</span> sequence = <span class="number">0</span>;</div><div class="line">    <span class="keyword">zhash_t</span> *kvmap = zhash_new ();</div><div class="line"></div><div class="line">    <span class="keyword">zmq_pollitem_t</span> items [] = &#123;</div><div class="line">        &#123; collector, <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125;,</div><div class="line">        &#123; snapshot, <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">while</span> (!zctx_interrupted) &#123;</div><div class="line">        <span class="keyword">int</span> rc = zmq_poll (items, <span class="number">2</span>, <span class="number">1000</span> * ZMQ_POLL_MSEC);</div><div class="line"></div><div class="line">        <span class="comment">//  执行来自客户端的更新事件</span></div><div class="line">        <span class="keyword">if</span> (items [<span class="number">0</span>].revents &amp; ZMQ_POLLIN) &#123;</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (collector);</div><div class="line">            <span class="keyword">if</span> (!kvmsg)</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  Interrupted</span></div><div class="line">            kvmsg_set_sequence (kvmsg, ++sequence);</div><div class="line">            kvmsg_send (kvmsg, publisher);</div><div class="line">            kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line">            <span class="built_in">printf</span> (<span class="string">"I: 发布更新事件 %5d\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  响应快照请求</span></div><div class="line">        <span class="keyword">if</span> (items [<span class="number">1</span>].revents &amp; ZMQ_POLLIN) &#123;</div><div class="line">            <span class="keyword">zframe_t</span> *identity = zframe_recv (snapshot);</div><div class="line">            <span class="keyword">if</span> (!identity)</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  Interrupted</span></div><div class="line"></div><div class="line">            <span class="comment">//  请求内容在消息的第二帧中</span></div><div class="line">            <span class="keyword">char</span> *request = zstr_recv (snapshot);</div><div class="line">            <span class="keyword">char</span> *subtree = <span class="literal">NULL</span>;</div><div class="line">            <span class="keyword">if</span> (streq (request, <span class="string">"ICANHAZ?"</span>)) &#123;</div><div class="line">                <span class="built_in">free</span> (request);</div><div class="line">                subtree = zstr_recv (snapshot);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">printf</span> (<span class="string">"E: 错误的请求，程序中止\n"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//  发送快照</span></div><div class="line">            <span class="keyword">kvroute_t</span> routing = &#123; snapshot, identity, subtree &#125;;</div><div class="line"></div><div class="line">            <span class="comment">//  逐条发送</span></div><div class="line">            zhash_foreach (kvmap, s_send_single, &amp;routing);</div><div class="line"></div><div class="line">            <span class="comment">//  发送结束标识和编号</span></div><div class="line">            <span class="built_in">printf</span> (<span class="string">"I: 正在发送快照，版本号：%d\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">            zframe_send (&amp;identity, snapshot, ZFRAME_MORE);</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (sequence);</div><div class="line">            kvmsg_set_key  (kvmsg, <span class="string">"KTHXBAI"</span>);</div><div class="line">            kvmsg_set_body (kvmsg, (byte *) subtree, <span class="number">0</span>);</div><div class="line">            kvmsg_send     (kvmsg, snapshot);</div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">            <span class="built_in">free</span> (subtree);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span> (<span class="string">" 已中断\n已处理 %d 条消息\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">    zhash_destroy (&amp;kvmap);</div><div class="line">    zctx_destroy (&amp;ctx);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  发送一条键值对状态给套接字，使用kvmsg对象保存键值对</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_send_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">kvroute_t</span> *kvroute = (<span class="keyword">kvroute_t</span> *) args;</div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = (<span class="keyword">kvmsg_t</span> *) data;</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span> (kvroute-&gt;subtree) &lt;= <span class="built_in">strlen</span> (kvmsg_key (kvmsg))</div><div class="line">    &amp;&amp;  <span class="built_in">memcmp</span> (kvroute-&gt;subtree,</div><div class="line">                kvmsg_key (kvmsg), <span class="built_in">strlen</span> (kvroute-&gt;subtree)) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//  先发送接收方的标识</span></div><div class="line">        zframe_send (&amp;kvroute-&gt;identity,</div><div class="line">            kvroute-&gt;socket, ZFRAME_MORE + ZFRAME_REUSE);</div><div class="line">        kvmsg_send (kvmsg, kvroute-&gt;socket);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是客户端代码：</p>
<p><strong>clonecli4: Clone client, Model Four in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  克隆模式 - 客户端 - 模型4</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="comment">//  直接编译，不创建类库</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvsimple.c"</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SUBTREE <span class="meta-string">"/client/"</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">//  准备上下文和SUB套接字</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx = zctx_new ();</div><div class="line">    <span class="keyword">void</span> *snapshot = zsocket_new (ctx, ZMQ_DEALER);</div><div class="line">    zsocket_connect (snapshot, <span class="string">"tcp://localhost:5556"</span>);</div><div class="line">    <span class="keyword">void</span> *subscriber = zsocket_new (ctx, ZMQ_SUB);</div><div class="line">    zsocket_connect (subscriber, <span class="string">"tcp://localhost:5557"</span>);</div><div class="line">    zsockopt_set_subscribe (subscriber, SUBTREE);</div><div class="line">    <span class="keyword">void</span> *publisher = zsocket_new (ctx, ZMQ_PUSH);</div><div class="line">    zsocket_connect (publisher, <span class="string">"tcp://localhost:5558"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">zhash_t</span> *kvmap = zhash_new ();</div><div class="line">    srandom ((<span class="keyword">unsigned</span>) time (<span class="literal">NULL</span>));</div><div class="line"></div><div class="line">    <span class="comment">//  获取状态快照</span></div><div class="line">    <span class="keyword">int64_t</span> sequence = <span class="number">0</span>;</div><div class="line">    zstr_sendm (snapshot, <span class="string">"ICANHAZ?"</span>);</div><div class="line">    zstr_send  (snapshot, SUBTREE);</div><div class="line">    <span class="keyword">while</span> (TRUE) &#123;</div><div class="line">        <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (snapshot);</div><div class="line">        <span class="keyword">if</span> (!kvmsg)</div><div class="line">            <span class="keyword">break</span>;          <span class="comment">//  Interrupted</span></div><div class="line">        <span class="keyword">if</span> (streq (kvmsg_key (kvmsg), <span class="string">"KTHXBAI"</span>)) &#123;</div><div class="line">            sequence = kvmsg_sequence (kvmsg);</div><div class="line">            <span class="built_in">printf</span> (<span class="string">"I: 已收到快照，版本号：%d\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">            <span class="keyword">break</span>;          <span class="comment">//  Done</span></div><div class="line">        &#125;</div><div class="line">        kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int64_t</span> alarm = zclock_time () + <span class="number">1000</span>;</div><div class="line">    <span class="keyword">while</span> (!zctx_interrupted) &#123;</div><div class="line">        <span class="keyword">zmq_pollitem_t</span> items [] = &#123; &#123; subscriber, <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125; &#125;;</div><div class="line">        <span class="keyword">int</span> tickless = (<span class="keyword">int</span>) ((alarm - zclock_time ()));</div><div class="line">        <span class="keyword">if</span> (tickless &lt; <span class="number">0</span>)</div><div class="line">            tickless = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> rc = zmq_poll (items, <span class="number">1</span>, tickless * ZMQ_POLL_MSEC);</div><div class="line">        <span class="keyword">if</span> (rc == <span class="number">-1</span>)</div><div class="line">            <span class="keyword">break</span>;              <span class="comment">//  上下文被关闭</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (items [<span class="number">0</span>].revents &amp; ZMQ_POLLIN) &#123;</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (subscriber);</div><div class="line">            <span class="keyword">if</span> (!kvmsg)</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line"></div><div class="line">            <span class="comment">//  丢弃过时消息，包括心跳</span></div><div class="line">            <span class="keyword">if</span> (kvmsg_sequence (kvmsg) &gt; sequence) &#123;</div><div class="line">                sequence = kvmsg_sequence (kvmsg);</div><div class="line">                kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line">                <span class="built_in">printf</span> (<span class="string">"I: 收到更新事件：%d\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                kvmsg_destroy (&amp;kvmsg);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  创建一个随机的更新事件</span></div><div class="line">        <span class="keyword">if</span> (zclock_time () &gt;= alarm) &#123;</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (<span class="number">0</span>);</div><div class="line">            kvmsg_fmt_key  (kvmsg, <span class="string">"%s%d"</span>, SUBTREE, randof (<span class="number">10000</span>));</div><div class="line">            kvmsg_fmt_body (kvmsg, <span class="string">"%d"</span>, randof (<span class="number">1000000</span>));</div><div class="line">            kvmsg_send     (kvmsg, publisher);</div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">            alarm = zclock_time () + <span class="number">1000</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span> (<span class="string">" 已准备\n收到 %d 条消息\n"</span>, (<span class="keyword">int</span>) sequence);</div><div class="line">    zhash_destroy (&amp;kvmap);</div><div class="line">    zctx_destroy (&amp;ctx);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="瞬间值"><a href="#瞬间值" class="headerlink" title="瞬间值"></a>瞬间值</h4><p>瞬间值指的是那些会立刻过期的值。如果你用克隆模式搭建一个类似DNS的服务时，就可以用瞬间值来模拟动态DNS解析了。当节点连接网络，对外发布它的地址，并不断地更新地址。如果节点断开连接，则它的地址也会失效。</p>
<p>瞬间值可以和会话（session）联系起来，当会话结束时，瞬间值也就失效了。克隆模式中，会话是有客户端定义的，并会在客户端断开连接时消亡。</p>
<p>更简单的方法是为每一个瞬间值设定一个过期时间，客户端会不断延长这个时间，当断开连接时这个时间将得不到更新，服务器就会自动将其删除。</p>
<p>我们会用这种简单的方法来实现瞬间值，因为太过复杂的方法可能不值当，它们的差别仅在性能上体现。如果客户端有很多瞬间值，那为每个值设定过期时间是恰当的；如果瞬间值到达一定的量，那最好还是将其和会话相关联，统一进行过期处理。</p>
<p>首先，我们需要设法在键值对消息中加入过期时间。我们可以增加一个消息帧，但这样一来每当我们需要增加消息内容时就需要修改kvmsg类库了，这并不合适。所以，我们一次性增加一个“属性”消息帧，用于添加不同的消息属性。</p>
<p>其次，我们需要设法删除这条数据。目前为止服务端和客户端会盲目地增改哈希表中的数据，我们可以这样定义：当消息的值是空的，则表示删除这个键的数据。</p>
<p>下面是一个更为完整的kvmsg类代码，它实现了“属性”帧，以及一个UUID帧，我们后面会用到。该类还会负责处理值为空的消息，达到删除的目的：</p>
<p><strong>kvmsg: Key-value message class - full in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*  =====================================================================</span></div><div class="line">    kvmsg - key-value message class for example applications</div><div class="line"></div><div class="line">    ---------------------------------------------------------------------</div><div class="line">    Copyright (c) 1991-2011 iMatix Corporation &lt;www.imatix.com&gt;</div><div class="line">    Copyright other contributors as noted in the AUTHORS file.</div><div class="line"></div><div class="line">    This file is part of the ZeroMQ Guide: http://zguide.zeromq.org</div><div class="line"></div><div class="line">    This is free software; you can redistribute it and/or modify it under</div><div class="line">    the terms of the GNU Lesser General Public License as published by</div><div class="line">    the Free Software Foundation; either version 3 of the License, or (at</div><div class="line">    your option) any later version.</div><div class="line"></div><div class="line">    This software is distributed in the hope that it will be useful, but</div><div class="line">    WITHOUT ANY WARRANTY; without even the implied warranty of</div><div class="line">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</div><div class="line">    Lesser General Public License for more details.</div><div class="line"></div><div class="line">    You should have received a copy of the GNU Lesser General Public</div><div class="line">    License along with this program. If not, see</div><div class="line">    &lt;http://www.gnu.org/licenses/&gt;.</div><div class="line">    =====================================================================</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvmsg.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uuid/uuid.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"zlist.h"</span></span></div><div class="line"></div><div class="line"><span class="comment">//  键是短字符串</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KVMSG_KEY_MAX   255</span></div><div class="line"></div><div class="line"><span class="comment">//  消息包含五帧</span></div><div class="line"><span class="comment">//  frame 0: 键(ZMQ字符串)</span></div><div class="line"><span class="comment">//  frame 1: 编号(8个字节，按顺序排列)</span></div><div class="line"><span class="comment">//  frame 2: UUID(二进制块，16个字节)</span></div><div class="line"><span class="comment">//  frame 3: 属性(ZMQ字符串)</span></div><div class="line"><span class="comment">//  frame 4: 值(二进制块)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FRAME_KEY       0</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FRAME_SEQ       1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FRAME_UUID      2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FRAME_PROPS     3</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FRAME_BODY      4</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KVMSG_FRAMES    5</span></div><div class="line"></div><div class="line"><span class="comment">//  类结构</span></div><div class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">kvmsg</span> &#123;</span></div><div class="line">    <span class="comment">//  帧是否存在</span></div><div class="line">    <span class="keyword">int</span> present [KVMSG_FRAMES];</div><div class="line">    <span class="comment">//  对应消息帧</span></div><div class="line">    <span class="keyword">zmq_msg_t</span> frame [KVMSG_FRAMES];</div><div class="line">    <span class="comment">//  键，C语言字符串格式</span></div><div class="line">    <span class="keyword">char</span> key [KVMSG_KEY_MAX + <span class="number">1</span>];</div><div class="line">    <span class="comment">//  属性列表，key=value形式</span></div><div class="line">    <span class="keyword">zlist_t</span> *props;</div><div class="line">    <span class="keyword">size_t</span> props_size;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  将属性列表序列化为字符串</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">s_encode_props</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">zmq_msg_t</span> *msg = &amp;self-&gt;frame [FRAME_PROPS];</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_PROPS])</div><div class="line">        zmq_msg_close (msg);</div><div class="line"></div><div class="line">    zmq_msg_init_size (msg, self-&gt;props_size);</div><div class="line">    <span class="keyword">char</span> *prop = zlist_first (self-&gt;props);</div><div class="line">    <span class="keyword">char</span> *dest = (<span class="keyword">char</span> *) zmq_msg_data (msg);</div><div class="line">    <span class="keyword">while</span> (prop) &#123;</div><div class="line">        <span class="built_in">strcpy</span> (dest, prop);</div><div class="line">        dest += <span class="built_in">strlen</span> (prop);</div><div class="line">        *dest++ = <span class="string">'\n'</span>;</div><div class="line">        prop = zlist_next (self-&gt;props);</div><div class="line">    &#125;</div><div class="line">    self-&gt;present [FRAME_PROPS] = <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  从字符串中解析属性列表</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">s_decode_props</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">zmq_msg_t</span> *msg = &amp;self-&gt;frame [FRAME_PROPS];</div><div class="line">    self-&gt;props_size = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (zlist_size (self-&gt;props))</div><div class="line">        <span class="built_in">free</span> (zlist_pop (self-&gt;props));</div><div class="line"></div><div class="line">    <span class="keyword">size_t</span> remainder = zmq_msg_size (msg);</div><div class="line">    <span class="keyword">char</span> *prop = (<span class="keyword">char</span> *) zmq_msg_data (msg);</div><div class="line">    <span class="keyword">char</span> *eoln = <span class="built_in">memchr</span> (prop, <span class="string">'\n'</span>, remainder);</div><div class="line">    <span class="keyword">while</span> (eoln) &#123;</div><div class="line">        *eoln = <span class="number">0</span>;</div><div class="line">        zlist_append (self-&gt;props, strdup (prop));</div><div class="line">        self-&gt;props_size += <span class="built_in">strlen</span> (prop) + <span class="number">1</span>;</div><div class="line">        remainder -= <span class="built_in">strlen</span> (prop) + <span class="number">1</span>;</div><div class="line">        prop = eoln + <span class="number">1</span>;</div><div class="line">        eoln = <span class="built_in">memchr</span> (prop, <span class="string">'\n'</span>, remainder);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  构造函数，指定消息编号</span></div><div class="line"></div><div class="line"><span class="keyword">kvmsg_t</span> *</div><div class="line">kvmsg_new (<span class="keyword">int64_t</span> sequence)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">kvmsg_t</span></div><div class="line">        *self;</div><div class="line"></div><div class="line">    self = (<span class="keyword">kvmsg_t</span> *) zmalloc (<span class="keyword">sizeof</span> (<span class="keyword">kvmsg_t</span>));</div><div class="line">    self-&gt;props = zlist_new ();</div><div class="line">    kvmsg_set_sequence (self, sequence);</div><div class="line">    <span class="keyword">return</span> self;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  析构函数</span></div><div class="line"></div><div class="line"><span class="comment">//  释放内存函数，供zhash_free_fn()调用</span></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_free</span> <span class="params">(<span class="keyword">void</span> *ptr)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (ptr) &#123;</div><div class="line">        <span class="keyword">kvmsg_t</span> *self = (<span class="keyword">kvmsg_t</span> *) ptr;</div><div class="line">        <span class="comment">//  释放所有消息帧</span></div><div class="line">        <span class="keyword">int</span> frame_nbr;</div><div class="line">        <span class="keyword">for</span> (frame_nbr = <span class="number">0</span>; frame_nbr &lt; KVMSG_FRAMES; frame_nbr++)</div><div class="line">            <span class="keyword">if</span> (self-&gt;present [frame_nbr])</div><div class="line">                zmq_msg_close (&amp;self-&gt;frame [frame_nbr]);</div><div class="line"></div><div class="line">        <span class="comment">//  释放属性列表</span></div><div class="line">        <span class="keyword">while</span> (zlist_size (self-&gt;props))</div><div class="line">            <span class="built_in">free</span> (zlist_pop (self-&gt;props));</div><div class="line">        zlist_destroy (&amp;self-&gt;props);</div><div class="line"></div><div class="line">        <span class="comment">//  释放对象本身</span></div><div class="line">        <span class="built_in">free</span> (self);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_destroy</span> <span class="params">(<span class="keyword">kvmsg_t</span> **self_p)</span></div><div class="line">&#123;</div><div class="line">    assert (self_p);</div><div class="line">    <span class="keyword">if</span> (*self_p) &#123;</div><div class="line">        kvmsg_free (*self_p);</div><div class="line">        *self_p = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  复制kvmsg对象</span></div><div class="line"></div><div class="line"><span class="keyword">kvmsg_t</span> *</div><div class="line">kvmsg_dup (<span class="keyword">kvmsg_t</span> *self)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (<span class="number">0</span>);</div><div class="line">    <span class="keyword">int</span> frame_nbr;</div><div class="line">    <span class="keyword">for</span> (frame_nbr = <span class="number">0</span>; frame_nbr &lt; KVMSG_FRAMES; frame_nbr++) &#123;</div><div class="line">        <span class="keyword">if</span> (self-&gt;present [frame_nbr]) &#123;</div><div class="line">            <span class="keyword">zmq_msg_t</span> *src = &amp;self-&gt;frame [frame_nbr];</div><div class="line">            <span class="keyword">zmq_msg_t</span> *dst = &amp;kvmsg-&gt;frame [frame_nbr];</div><div class="line">            zmq_msg_init_size (dst, zmq_msg_size (src));</div><div class="line">            <span class="built_in">memcpy</span> (zmq_msg_data (dst),</div><div class="line">                    zmq_msg_data (src), zmq_msg_size (src));</div><div class="line">            kvmsg-&gt;present [frame_nbr] = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    kvmsg-&gt;props = zlist_copy (self-&gt;props);</div><div class="line">    <span class="keyword">return</span> kvmsg;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  从套接字总读取键值对，返回kvmsg实例</span></div><div class="line"></div><div class="line"><span class="keyword">kvmsg_t</span> *</div><div class="line">kvmsg_recv (<span class="keyword">void</span> *socket)</div><div class="line">&#123;</div><div class="line">    assert (socket);</div><div class="line">    <span class="keyword">kvmsg_t</span> *self = kvmsg_new (<span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">//  读取所有帧，若有异常则直接返回空</span></div><div class="line">    <span class="keyword">int</span> frame_nbr;</div><div class="line">    <span class="keyword">for</span> (frame_nbr = <span class="number">0</span>; frame_nbr &lt; KVMSG_FRAMES; frame_nbr++) &#123;</div><div class="line">        <span class="keyword">if</span> (self-&gt;present [frame_nbr])</div><div class="line">            zmq_msg_close (&amp;self-&gt;frame [frame_nbr]);</div><div class="line">        zmq_msg_init (&amp;self-&gt;frame [frame_nbr]);</div><div class="line">        self-&gt;present [frame_nbr] = <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (zmq_recvmsg (socket, &amp;self-&gt;frame [frame_nbr], <span class="number">0</span>) == <span class="number">-1</span>) &#123;</div><div class="line">            kvmsg_destroy (&amp;self);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  验证多帧消息</span></div><div class="line">        <span class="keyword">int</span> rcvmore = (frame_nbr &lt; KVMSG_FRAMES - <span class="number">1</span>)? <span class="number">1</span>: <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (zsockopt_rcvmore (socket) != rcvmore) &#123;</div><div class="line">            kvmsg_destroy (&amp;self);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (self)</div><div class="line">        s_decode_props (self);</div><div class="line">    <span class="keyword">return</span> self;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  向套接字发送键值对消息，空消息也发送</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_send</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">void</span> *socket)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    assert (socket);</div><div class="line"></div><div class="line">    s_encode_props (self);</div><div class="line">    <span class="keyword">int</span> frame_nbr;</div><div class="line">    <span class="keyword">for</span> (frame_nbr = <span class="number">0</span>; frame_nbr &lt; KVMSG_FRAMES; frame_nbr++) &#123;</div><div class="line">        <span class="keyword">zmq_msg_t</span> copy;</div><div class="line">        zmq_msg_init (&amp;copy);</div><div class="line">        <span class="keyword">if</span> (self-&gt;present [frame_nbr])</div><div class="line">            zmq_msg_copy (&amp;copy, &amp;self-&gt;frame [frame_nbr]);</div><div class="line">        zmq_sendmsg (socket, &amp;copy,</div><div class="line">            (frame_nbr &lt; KVMSG_FRAMES - <span class="number">1</span>)? ZMQ_SNDMORE: <span class="number">0</span>);</div><div class="line">        zmq_msg_close (&amp;copy);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  返回消息的键</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span> *</span></div><div class="line"><span class="title">kvmsg_key</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_KEY]) &#123;</div><div class="line">        <span class="keyword">if</span> (!*self-&gt;key) &#123;</div><div class="line">            <span class="keyword">size_t</span> size = zmq_msg_size (&amp;self-&gt;frame [FRAME_KEY]);</div><div class="line">            <span class="keyword">if</span> (size &gt; KVMSG_KEY_MAX)</div><div class="line">                size = KVMSG_KEY_MAX;</div><div class="line">            <span class="built_in">memcpy</span> (self-&gt;key,</div><div class="line">                zmq_msg_data (&amp;self-&gt;frame [FRAME_KEY]), size);</div><div class="line">            self-&gt;key [size] = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> self-&gt;key;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  返回消息的编号</span></div><div class="line"></div><div class="line"><span class="keyword">int64_t</span></div><div class="line">kvmsg_sequence (<span class="keyword">kvmsg_t</span> *self)</div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_SEQ]) &#123;</div><div class="line">        assert (zmq_msg_size (&amp;self-&gt;frame [FRAME_SEQ]) == <span class="number">8</span>);</div><div class="line">        byte *source = zmq_msg_data (&amp;self-&gt;frame [FRAME_SEQ]);</div><div class="line">        <span class="keyword">int64_t</span> sequence = ((<span class="keyword">int64_t</span>) (source [<span class="number">0</span>]) &lt;&lt; <span class="number">56</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">1</span>]) &lt;&lt; <span class="number">48</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">2</span>]) &lt;&lt; <span class="number">40</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">3</span>]) &lt;&lt; <span class="number">32</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">4</span>]) &lt;&lt; <span class="number">24</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">5</span>]) &lt;&lt; <span class="number">16</span>)</div><div class="line">                         + ((<span class="keyword">int64_t</span>) (source [<span class="number">6</span>]) &lt;&lt; <span class="number">8</span>)</div><div class="line">                         +  (<span class="keyword">int64_t</span>) (source [<span class="number">7</span>]);</div><div class="line">        <span class="keyword">return</span> sequence;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  返回消息的UUID</span></div><div class="line"></div><div class="line"><span class="function">byte *</span></div><div class="line"><span class="title">kvmsg_uuid</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_UUID]</div><div class="line">    &amp;&amp;  zmq_msg_size (&amp;self-&gt;frame [FRAME_UUID]) == <span class="keyword">sizeof</span> (<span class="keyword">uuid_t</span>))</div><div class="line">        <span class="keyword">return</span> (byte *) zmq_msg_data (&amp;self-&gt;frame [FRAME_UUID]);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  返回消息的内容</span></div><div class="line"></div><div class="line"><span class="function">byte *</span></div><div class="line"><span class="title">kvmsg_body</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_BODY])</div><div class="line">        <span class="keyword">return</span> (byte *) zmq_msg_data (&amp;self-&gt;frame [FRAME_BODY]);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  返回消息内容的长度</span></div><div class="line"></div><div class="line"><span class="keyword">size_t</span></div><div class="line">kvmsg_size (<span class="keyword">kvmsg_t</span> *self)</div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_BODY])</div><div class="line">        <span class="keyword">return</span> zmq_msg_size (&amp;self-&gt;frame [FRAME_BODY]);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  设置消息的键</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_set_key</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">char</span> *key)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">zmq_msg_t</span> *msg = &amp;self-&gt;frame [FRAME_KEY];</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_KEY])</div><div class="line">        zmq_msg_close (msg);</div><div class="line">    zmq_msg_init_size (msg, <span class="built_in">strlen</span> (key));</div><div class="line">    <span class="built_in">memcpy</span> (zmq_msg_data (msg), key, <span class="built_in">strlen</span> (key));</div><div class="line">    self-&gt;present [FRAME_KEY] = <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  设置消息的编号</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_set_sequence</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">int64_t</span> sequence)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">zmq_msg_t</span> *msg = &amp;self-&gt;frame [FRAME_SEQ];</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_SEQ])</div><div class="line">        zmq_msg_close (msg);</div><div class="line">    zmq_msg_init_size (msg, <span class="number">8</span>);</div><div class="line"></div><div class="line">    byte *source = zmq_msg_data (msg);</div><div class="line">    source [<span class="number">0</span>] = (byte) ((sequence &gt;&gt; <span class="number">56</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">1</span>] = (byte) ((sequence &gt;&gt; <span class="number">48</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">2</span>] = (byte) ((sequence &gt;&gt; <span class="number">40</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">3</span>] = (byte) ((sequence &gt;&gt; <span class="number">32</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">4</span>] = (byte) ((sequence &gt;&gt; <span class="number">24</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">5</span>] = (byte) ((sequence &gt;&gt; <span class="number">16</span>) &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">6</span>] = (byte) ((sequence &gt;&gt; <span class="number">8</span>)  &amp; <span class="number">255</span>);</div><div class="line">    source [<span class="number">7</span>] = (byte) ((sequence)       &amp; <span class="number">255</span>);</div><div class="line"></div><div class="line">    self-&gt;present [FRAME_SEQ] = <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  生成并设置消息的UUID</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_set_uuid</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">zmq_msg_t</span> *msg = &amp;self-&gt;frame [FRAME_UUID];</div><div class="line">    <span class="keyword">uuid_t</span> uuid;</div><div class="line">    uuid_generate (uuid);</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_UUID])</div><div class="line">        zmq_msg_close (msg);</div><div class="line">    zmq_msg_init_size (msg, <span class="keyword">sizeof</span> (uuid));</div><div class="line">    <span class="built_in">memcpy</span> (zmq_msg_data (msg), uuid, <span class="keyword">sizeof</span> (uuid));</div><div class="line">    self-&gt;present [FRAME_UUID] = <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  设置消息的内容</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_set_body</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, byte *body, <span class="keyword">size_t</span> size)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">zmq_msg_t</span> *msg = &amp;self-&gt;frame [FRAME_BODY];</div><div class="line">    <span class="keyword">if</span> (self-&gt;present [FRAME_BODY])</div><div class="line">        zmq_msg_close (msg);</div><div class="line">    self-&gt;present [FRAME_BODY] = <span class="number">1</span>;</div><div class="line">    zmq_msg_init_size (msg, size);</div><div class="line">    <span class="built_in">memcpy</span> (zmq_msg_data (msg), body, size);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  使用printf()格式设置消息的键</span></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_fmt_key</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">char</span> *format, ...)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> value [KVMSG_KEY_MAX + <span class="number">1</span>];</div><div class="line">    va_list args;</div><div class="line"></div><div class="line">    assert (self);</div><div class="line">    va_start (args, format);</div><div class="line">    vsnprintf (value, KVMSG_KEY_MAX, format, args);</div><div class="line">    va_end (args);</div><div class="line">    kvmsg_set_key (self, value);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  使用printf()格式设置消息内容</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_fmt_body</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">char</span> *format, ...)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> value [<span class="number">255</span> + <span class="number">1</span>];</div><div class="line">    va_list args;</div><div class="line"></div><div class="line">    assert (self);</div><div class="line">    va_start (args, format);</div><div class="line">    vsnprintf (value, <span class="number">255</span>, format, args);</div><div class="line">    va_end (args);</div><div class="line">    kvmsg_set_body (self, (byte *) value, <span class="built_in">strlen</span> (value));</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  获取消息属性，无则返回空字符串</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span> *</span></div><div class="line"><span class="title">kvmsg_get_prop</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">char</span> *name)</span></div><div class="line">&#123;</div><div class="line">    assert (<span class="built_in">strchr</span> (name, <span class="string">'='</span>) == <span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">char</span> *prop = zlist_first (self-&gt;props);</div><div class="line">    <span class="keyword">size_t</span> namelen = <span class="built_in">strlen</span> (name);</div><div class="line">    <span class="keyword">while</span> (prop) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">strlen</span> (prop) &gt; namelen</div><div class="line">        &amp;&amp;  <span class="built_in">memcmp</span> (prop, name, namelen) == <span class="number">0</span></div><div class="line">        &amp;&amp;  prop [namelen] == <span class="string">'='</span>)</div><div class="line">            <span class="keyword">return</span> prop + namelen + <span class="number">1</span>;</div><div class="line">        prop = zlist_next (self-&gt;props);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  设置消息属性</span></div><div class="line"><span class="comment">//  属性名称不能包含=号，值的最大长度是255</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_set_prop</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self, <span class="keyword">char</span> *name, <span class="keyword">char</span> *format, ...)</span></div><div class="line">&#123;</div><div class="line">    assert (<span class="built_in">strchr</span> (name, <span class="string">'='</span>) == <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">    <span class="keyword">char</span> value [<span class="number">255</span> + <span class="number">1</span>];</div><div class="line">    va_list args;</div><div class="line">    assert (self);</div><div class="line">    va_start (args, format);</div><div class="line">    vsnprintf (value, <span class="number">255</span>, format, args);</div><div class="line">    va_end (args);</div><div class="line"></div><div class="line">    <span class="comment">//  分配空间</span></div><div class="line">    <span class="keyword">char</span> *prop = <span class="built_in">malloc</span> (<span class="built_in">strlen</span> (name) + <span class="built_in">strlen</span> (value) + <span class="number">2</span>);</div><div class="line"></div><div class="line">    <span class="comment">//  删除已存在的属性</span></div><div class="line">    <span class="built_in">sprintf</span> (prop, <span class="string">"%s="</span>, name);</div><div class="line">    <span class="keyword">char</span> *existing = zlist_first (self-&gt;props);</div><div class="line">    <span class="keyword">while</span> (existing) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">memcmp</span> (prop, existing, <span class="built_in">strlen</span> (prop)) == <span class="number">0</span>) &#123;</div><div class="line">            self-&gt;props_size -= <span class="built_in">strlen</span> (existing) + <span class="number">1</span>;</div><div class="line">            zlist_remove (self-&gt;props, existing);</div><div class="line">            <span class="built_in">free</span> (existing);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        existing = zlist_next (self-&gt;props);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//  添加新属性</span></div><div class="line">    <span class="built_in">strcat</span> (prop, value);</div><div class="line">    zlist_append (self-&gt;props, prop);</div><div class="line">    self-&gt;props_size += <span class="built_in">strlen</span> (prop) + <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  在哈希表中保存kvmsg对象</span></div><div class="line"><span class="comment">//  当kvmsg对象不再被使用时进行释放操作；</span></div><div class="line"><span class="comment">//  若传入的值为空，则删除该对象。</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_store</span> <span class="params">(<span class="keyword">kvmsg_t</span> **self_p, <span class="keyword">zhash_t</span> *hash)</span></div><div class="line">&#123;</div><div class="line">    assert (self_p);</div><div class="line">    <span class="keyword">if</span> (*self_p) &#123;</div><div class="line">        <span class="keyword">kvmsg_t</span> *self = *self_p;</div><div class="line">        assert (self);</div><div class="line">        <span class="keyword">if</span> (kvmsg_size (self)) &#123;</div><div class="line">            <span class="keyword">if</span> (self-&gt;present [FRAME_KEY]</div><div class="line">            &amp;&amp;  self-&gt;present [FRAME_BODY]) &#123;</div><div class="line">                zhash_update (hash, kvmsg_key (self), self);</div><div class="line">                zhash_freefn (hash, kvmsg_key (self), kvmsg_free);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            zhash_delete (hash, kvmsg_key (self));</div><div class="line"></div><div class="line">        *self_p = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  将消息内容输出到标准错误输出</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">kvmsg_dump</span> <span class="params">(<span class="keyword">kvmsg_t</span> *self)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (self) &#123;</div><div class="line">        <span class="keyword">if</span> (!self) &#123;</div><div class="line">            <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"NULL"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">size_t</span> size = kvmsg_size (self);</div><div class="line">        byte  *body = kvmsg_body (self);</div><div class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"[seq:%"</span> PRId64 <span class="string">"]"</span>, kvmsg_sequence (self));</div><div class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"[key:%s]"</span>, kvmsg_key (self));</div><div class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"[size:%zd] "</span>, size);</div><div class="line">        <span class="keyword">if</span> (zlist_size (self-&gt;props)) &#123;</div><div class="line">            <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"["</span>);</div><div class="line">            <span class="keyword">char</span> *prop = zlist_first (self-&gt;props);</div><div class="line">            <span class="keyword">while</span> (prop) &#123;</div><div class="line">                <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"%s;"</span>, prop);</div><div class="line">                prop = zlist_next (self-&gt;props);</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"]"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> char_nbr;</div><div class="line">        <span class="keyword">for</span> (char_nbr = <span class="number">0</span>; char_nbr &lt; size; char_nbr++)</div><div class="line">            <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"%02X"</span>, body [char_nbr]);</div><div class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"\n"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">"NULL message\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  测试用例</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span></span></div><div class="line"><span class="title">kvmsg_test</span> <span class="params">(<span class="keyword">int</span> verbose)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">kvmsg_t</span></div><div class="line">        *kvmsg;</div><div class="line"></div><div class="line">    <span class="built_in">printf</span> (<span class="string">" * kvmsg: "</span>);</div><div class="line"></div><div class="line">    <span class="comment">//  准备上下文和套接字</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx = zctx_new ();</div><div class="line">    <span class="keyword">void</span> *output = zsocket_new (ctx, ZMQ_DEALER);</div><div class="line">    <span class="keyword">int</span> rc = zmq_bind (output, <span class="string">"ipc://kvmsg_selftest.ipc"</span>);</div><div class="line">    assert (rc == <span class="number">0</span>);</div><div class="line">    <span class="keyword">void</span> *input = zsocket_new (ctx, ZMQ_DEALER);</div><div class="line">    rc = zmq_connect (input, <span class="string">"ipc://kvmsg_selftest.ipc"</span>);</div><div class="line">    assert (rc == <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">zhash_t</span> *kvmap = zhash_new ();</div><div class="line"></div><div class="line">    <span class="comment">//  测试简单消息的收发</span></div><div class="line">    kvmsg = kvmsg_new (<span class="number">1</span>);</div><div class="line">    kvmsg_set_key  (kvmsg, <span class="string">"key"</span>);</div><div class="line">    kvmsg_set_uuid (kvmsg);</div><div class="line">    kvmsg_set_body (kvmsg, (byte *) <span class="string">"body"</span>, <span class="number">4</span>);</div><div class="line">    <span class="keyword">if</span> (verbose)</div><div class="line">        kvmsg_dump (kvmsg);</div><div class="line">    kvmsg_send (kvmsg, output);</div><div class="line">    kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line"></div><div class="line">    kvmsg = kvmsg_recv (input);</div><div class="line">    <span class="keyword">if</span> (verbose)</div><div class="line">        kvmsg_dump (kvmsg);</div><div class="line">    assert (streq (kvmsg_key (kvmsg), <span class="string">"key"</span>));</div><div class="line">    kvmsg_store (&amp;kvmsg, kvmap);</div><div class="line"></div><div class="line">    <span class="comment">// 测试带有属性的消息的收发</span></div><div class="line">    kvmsg = kvmsg_new (<span class="number">2</span>);</div><div class="line">    kvmsg_set_prop (kvmsg, <span class="string">"prop1"</span>, <span class="string">"value1"</span>);</div><div class="line">    kvmsg_set_prop (kvmsg, <span class="string">"prop2"</span>, <span class="string">"value1"</span>);</div><div class="line">    kvmsg_set_prop (kvmsg, <span class="string">"prop2"</span>, <span class="string">"value2"</span>);</div><div class="line">    kvmsg_set_key  (kvmsg, <span class="string">"key"</span>);</div><div class="line">    kvmsg_set_uuid (kvmsg);</div><div class="line">    kvmsg_set_body (kvmsg, (byte *) <span class="string">"body"</span>, <span class="number">4</span>);</div><div class="line">    assert (streq (kvmsg_get_prop (kvmsg, <span class="string">"prop2"</span>), <span class="string">"value2"</span>));</div><div class="line">    <span class="keyword">if</span> (verbose)</div><div class="line">        kvmsg_dump (kvmsg);</div><div class="line">    kvmsg_send (kvmsg, output);</div><div class="line">    kvmsg_destroy (&amp;kvmsg);</div><div class="line"></div><div class="line">    kvmsg = kvmsg_recv (input);</div><div class="line">    <span class="keyword">if</span> (verbose)</div><div class="line">        kvmsg_dump (kvmsg);</div><div class="line">    assert (streq (kvmsg_key (kvmsg), <span class="string">"key"</span>));</div><div class="line">    assert (streq (kvmsg_get_prop (kvmsg, <span class="string">"prop2"</span>), <span class="string">"value2"</span>));</div><div class="line">    kvmsg_destroy (&amp;kvmsg);</div><div class="line"></div><div class="line">    <span class="comment">//  关闭并销毁所有对象</span></div><div class="line">    zhash_destroy (&amp;kvmap);</div><div class="line">    zctx_destroy (&amp;ctx);</div><div class="line"></div><div class="line">    <span class="built_in">printf</span> (<span class="string">"OK\n"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端模型5和模型4没有太大区别，只是kvmsg类库变了。在更新消息的时候还需要添加一个过期时间的属性：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kvmsg_set_prop (kvmsg, <span class="string">"ttl"</span>, <span class="string">"%d"</span>, randof (<span class="number">30</span>));</div></pre></td></tr></table></figure>
<p>服务端模型5有较大的变化，我们会用反应堆来代替轮询，这样就能混合处理定时事件和套接字事件了，只是在C语言中是比较麻烦的。下面是代码：</p>
<p><strong>clonesrv5: Clone server, Model Five in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  克隆模式 - 服务端 - 模型5</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="comment">//  直接编译，不建类库</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvmsg.c"</span></span></div><div class="line"></div><div class="line"><span class="comment">//  反应堆处理器</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_snapshots</span>  <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *socket, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_collector</span>  <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *socket, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_flush_ttl</span>  <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *socket, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">//  服务器属性</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx;                <span class="comment">//  上下文</span></div><div class="line">    <span class="keyword">zhash_t</span> *kvmap;             <span class="comment">//  键值对存储</span></div><div class="line">    <span class="keyword">zloop_t</span> *loop;              <span class="comment">//  zloop反应堆</span></div><div class="line">    <span class="keyword">int</span> port;                   <span class="comment">//  主端口</span></div><div class="line">    <span class="keyword">int64_t</span> sequence;           <span class="comment">//  更新事件编号</span></div><div class="line">    <span class="keyword">void</span> *snapshot;             <span class="comment">//  处理快照请求</span></div><div class="line">    <span class="keyword">void</span> *publisher;            <span class="comment">//  发布更新事件</span></div><div class="line">    <span class="keyword">void</span> *collector;            <span class="comment">//  从客户端收集接收更新事件</span></div><div class="line">&#125; <span class="keyword">clonesrv_t</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) zmalloc (<span class="keyword">sizeof</span> (<span class="keyword">clonesrv_t</span>));</div><div class="line"></div><div class="line">    self-&gt;port = <span class="number">5556</span>;</div><div class="line">    self-&gt;ctx = zctx_new ();</div><div class="line">    self-&gt;kvmap = zhash_new ();</div><div class="line">    self-&gt;loop = zloop_new ();</div><div class="line">    zloop_set_verbose (self-&gt;loop, FALSE);</div><div class="line"></div><div class="line">    <span class="comment">//  打开克隆模式服务端套接字</span></div><div class="line">    self-&gt;snapshot  = zsocket_new (self-&gt;ctx, ZMQ_ROUTER);</div><div class="line">    self-&gt;publisher = zsocket_new (self-&gt;ctx, ZMQ_PUB);</div><div class="line">    self-&gt;collector = zsocket_new (self-&gt;ctx, ZMQ_PULL);</div><div class="line">    zsocket_bind (self-&gt;snapshot,  <span class="string">"tcp://*:%d"</span>, self-&gt;port);</div><div class="line">    zsocket_bind (self-&gt;publisher, <span class="string">"tcp://*:%d"</span>, self-&gt;port + <span class="number">1</span>);</div><div class="line">    zsocket_bind (self-&gt;collector, <span class="string">"tcp://*:%d"</span>, self-&gt;port + <span class="number">2</span>);</div><div class="line"></div><div class="line">    <span class="comment">//  注册反应堆处理程序</span></div><div class="line">    zloop_reader (self-&gt;loop, self-&gt;snapshot, s_snapshots, self);</div><div class="line">    zloop_reader (self-&gt;loop, self-&gt;collector, s_collector, self);</div><div class="line">    zloop_timer  (self-&gt;loop, <span class="number">1000</span>, <span class="number">0</span>, s_flush_ttl, self);</div><div class="line"></div><div class="line">    <span class="comment">//  运行反应堆，直至中断</span></div><div class="line">    zloop_start (self-&gt;loop);</div><div class="line"></div><div class="line">    zloop_destroy (&amp;self-&gt;loop);</div><div class="line">    zhash_destroy (&amp;self-&gt;kvmap);</div><div class="line">    zctx_destroy (&amp;self-&gt;ctx);</div><div class="line">    <span class="built_in">free</span> (self);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  发送快照内容</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_send_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">//  请求方信息</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    <span class="keyword">void</span> *socket;           <span class="comment">//  ROUTER套接字</span></div><div class="line">    <span class="keyword">zframe_t</span> *identity;     <span class="comment">//  请求方标识</span></div><div class="line">    <span class="keyword">char</span> *subtree;          <span class="comment">//  子树信息</span></div><div class="line">&#125; <span class="keyword">kvroute_t</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_snapshots</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *snapshot, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line"></div><div class="line">    <span class="keyword">zframe_t</span> *identity = zframe_recv (snapshot);</div><div class="line">    <span class="keyword">if</span> (identity) &#123;</div><div class="line">        <span class="comment">//  请求位于消息第二帧</span></div><div class="line">        <span class="keyword">char</span> *request = zstr_recv (snapshot);</div><div class="line">        <span class="keyword">char</span> *subtree = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">if</span> (streq (request, <span class="string">"ICANHAZ?"</span>)) &#123;</div><div class="line">            <span class="built_in">free</span> (request);</div><div class="line">            subtree = zstr_recv (snapshot);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="built_in">printf</span> (<span class="string">"E: 错误的请求，程序中止\n"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (subtree) &#123;</div><div class="line">            <span class="comment">//  发送状态快照</span></div><div class="line">            <span class="keyword">kvroute_t</span> routing = &#123; snapshot, identity, subtree &#125;;</div><div class="line">            zhash_foreach (self-&gt;kvmap, s_send_single, &amp;routing);</div><div class="line"></div><div class="line">            <span class="comment">//  发送结束符和版本号</span></div><div class="line">            zclock_log (<span class="string">"I: 正在发送快照，版本号：%d"</span>, (<span class="keyword">int</span>) self-&gt;sequence);</div><div class="line">            zframe_send (&amp;identity, snapshot, ZFRAME_MORE);</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (self-&gt;sequence);</div><div class="line">            kvmsg_set_key  (kvmsg, <span class="string">"KTHXBAI"</span>);</div><div class="line">            kvmsg_set_body (kvmsg, (byte *) subtree, <span class="number">0</span>);</div><div class="line">            kvmsg_send     (kvmsg, snapshot);</div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">            <span class="built_in">free</span> (subtree);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  每次发送一个快照键值对</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_send_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">kvroute_t</span> *kvroute = (<span class="keyword">kvroute_t</span> *) args;</div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = (<span class="keyword">kvmsg_t</span> *) data;</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span> (kvroute-&gt;subtree) &lt;= <span class="built_in">strlen</span> (kvmsg_key (kvmsg))</div><div class="line">    &amp;&amp;  <span class="built_in">memcmp</span> (kvroute-&gt;subtree,</div><div class="line">                kvmsg_key (kvmsg), <span class="built_in">strlen</span> (kvroute-&gt;subtree)) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//  先发送接收方标识</span></div><div class="line">        zframe_send (&amp;kvroute-&gt;identity,</div><div class="line">            kvroute-&gt;socket, ZFRAME_MORE + ZFRAME_REUSE);</div><div class="line">        kvmsg_send (kvmsg, kvroute-&gt;socket);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  收集更新事件</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_collector</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *collector, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line"></div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (collector);</div><div class="line">    <span class="keyword">if</span> (kvmsg) &#123;</div><div class="line">        kvmsg_set_sequence (kvmsg, ++self-&gt;sequence);</div><div class="line">        kvmsg_send (kvmsg, self-&gt;publisher);</div><div class="line">        <span class="keyword">int</span> ttl = atoi (kvmsg_get_prop (kvmsg, <span class="string">"ttl"</span>));</div><div class="line">        <span class="keyword">if</span> (ttl)</div><div class="line">            kvmsg_set_prop (kvmsg, <span class="string">"ttl"</span>,</div><div class="line">                <span class="string">"%"</span> PRId64, zclock_time () + ttl * <span class="number">1000</span>);</div><div class="line">        kvmsg_store (&amp;kvmsg, self-&gt;kvmap);</div><div class="line">        zclock_log (<span class="string">"I: 正在发布更新事件 %d"</span>, (<span class="keyword">int</span>) self-&gt;sequence);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  删除过期的瞬间值</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_flush_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_flush_ttl</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *unused, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line">    zhash_foreach (self-&gt;kvmap, s_flush_single, args);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  删除过期的键值对，并广播该事件</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_flush_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line"></div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = (<span class="keyword">kvmsg_t</span> *) data;</div><div class="line">    <span class="keyword">int64_t</span> ttl;</div><div class="line">    <span class="built_in">sscanf</span> (kvmsg_get_prop (kvmsg, <span class="string">"ttl"</span>), <span class="string">"%"</span> PRId64, &amp;ttl);</div><div class="line">    <span class="keyword">if</span> (ttl &amp;&amp; zclock_time () &gt;= ttl) &#123;</div><div class="line">        kvmsg_set_sequence (kvmsg, ++self-&gt;sequence);</div><div class="line">        kvmsg_set_body (kvmsg, (byte *) <span class="string">""</span>, <span class="number">0</span>);</div><div class="line">        kvmsg_send (kvmsg, self-&gt;publisher);</div><div class="line">        kvmsg_store (&amp;kvmsg, self-&gt;kvmap);</div><div class="line">        zclock_log (<span class="string">"I: 发布删除事件 %d"</span>, (<span class="keyword">int</span>) self-&gt;sequence);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="克隆服务器的可靠性"><a href="#克隆服务器的可靠性" class="headerlink" title="克隆服务器的可靠性"></a>克隆服务器的可靠性</h4><p>克隆模型1至5相对比较简单，下面我们会探讨一个非常复杂的模型。可以发现，为了构建可靠的消息队列，我们需要花费非常多的精力。所以我们经常会问：有必要这么做吗？如果说你能够接受可靠性不够高的、或者说已经足够好的架构，那恭喜你，你在成本和收益之间找到了平衡。虽然我们会偶尔丢失一些消息，但从经济的角度来说还是合理的。不管怎样，下面我们就来介绍这个复杂的模型。</p>
<p>在模型3中，你会关闭和重启服务，这会导致数据的丢失。任何后续加入的客户端只能得到重启之后的那些数据，而非所有的。下面就让我们想办法让克隆模式能够承担服务器重启的故障。</p>
<p>以下列举我们需要处理的问题：</p>
<ul>
<li><p>克隆服务器进程崩溃并自动或手工重启。进程丢失了所有数据，所以必须从别处进行恢复。</p>
</li>
<li><p>克隆服务器硬件故障，长时间不能恢复。客户端需要切换至另一个可用的服务端。</p>
</li>
<li><p>克隆服务器从网络上断开，如交换机发生故障等。它会在某个时点重连，但期间的数据就需要替代的服务器负责处理。</p>
</li>
</ul>
<p>第一步我们需要增加一个服务器。我们可以使用第四章中提到的双子星模式，它是一个反应堆，而我们的程序经过整理后也是一个反应堆，因此可以互相协作。</p>
<p>我们需要保证更新事件在主服务器崩溃时仍能保留，最简单的机制就是同时发送给两台服务器。</p>
<p>备机就可以当做一台客户端来运行，像其他客户端一样从主机获取更新事件。同时它又能从客户端获取更新事件——虽然不应该以此更新数据，但可以先暂存起来。</p>
<p>所以，相较于模型5，模型6中引入了以下特性：</p>
<ul>
<li><p>客户端发送更新事件改用PUB-SUB套接字，而非PUSH-PULL。原因是PUSH套接字会在没有接收方时阻塞，且会进行负载均衡——我们需要两台服务器都接收到消息。我们会在服务器端绑定SUB套接字，在客户端连接PUB套接字。</p>
</li>
<li><p>我们在服务器发送给客户端的更新事件中加入心跳，这样客户端可以知道主机是否已死，然后切换至备机。</p>
</li>
<li><p>我们使用双子星模式的bstar反应堆类来创建主机和备机。双子星模式中需要有一个“投票”套接字，来协助判定对方节点是否已死。这里我们使用快照请求来作为“投票”。</p>
</li>
<li><p>我们将为所有的更新事件添加UUID属性，它由客户端生成，服务端会将其发布给所有客户端。</p>
</li>
<li><p>备机将维护一个“待处理列表”，保存来自客户端、尚未由服务端发布的更新事件；或者反过来，来自服务端、尚未从客户端收到的更新事件。这个列表从旧到新排列，这样就能方便地从顶部删除消息。</p>
</li>
</ul>
<p>我们可以为客户端设计一个有限状态机，它有三种状态：</p>
<ul>
<li><p>客户端打开并连接了套接字，然后向服务端发送快照请求。为了避免消息风暴，它只会请求两次。</p>
</li>
<li><p>客户端等待快照应答，如果获得了则保存它；如果没有获得，则向第二个服务器发送请求。</p>
</li>
<li><p>客户端收到快照，便开始等待更新事件。如果在一定时间内没有收到服务端响应，则会连接第二个服务端。</p>
</li>
</ul>
<p>客户端会一直循环下去，可能在程序刚启动时，部分客户端会试图连接主机，部分连接备机，相信双子星模式会很好地处理这一情况的。</p>
<p>我们可以将客户端状态图绘制出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> +-----------+</div><div class="line"> |           |&lt;----------------------\</div><div class="line"> |  Initial  |&lt;-------------------\  |</div><div class="line"> |           |                    |  |</div><div class="line"> +-----+-----+                    |  |</div><div class="line">Request|snapshot                  |  |</div><div class="line">       |   /----------------\     |  |</div><div class="line">       |   |                |     |  |</div><div class="line">       v   v                |     |  |</div><div class="line"> +-----------+              |     |  |</div><div class="line"> |           +-INPUT--------/     |  |</div><div class="line"> |  Syncing  | Store snapshot     |  |</div><div class="line"> |           |                    |  |</div><div class="line"> |           +-SILENCE------------/  |</div><div class="line"> +-----+-----+ Failover to next      |</div><div class="line">    KTHXBAI                          |</div><div class="line">       |   /----------------\        |</div><div class="line">       |   |                |        |</div><div class="line">       v   v                |        |</div><div class="line"> +-----------+              |        |</div><div class="line"> |           +-INPUT--------/        |</div><div class="line"> |  Active   | Store update          |</div><div class="line"> |           |                       |</div><div class="line"> |           +-SILENCE---------------/</div><div class="line"> +-----------+ Failover to next</div><div class="line"></div><div class="line"></div><div class="line">     Figure # - Clone client FSM</div></pre></td></tr></table></figure>
<p>故障恢复的步骤如下：</p>
<ul>
<li>客户端检测到主机不再发送心跳，因此转而连接备机，并请求一份新的快照；</li>
<li>备机开始接收快照请求，并检测到主机死亡，于是开始作为主机运行；</li>
<li>备机将待处理列表中的更新事件写入自身状态中，然后开始处理快照请求。</li>
</ul>
<p>当主机恢复连接时：</p>
<ul>
<li>启动为slave状态，并作为克隆模式客户端连接备机；</li>
<li>同时，使用SUB套接字从客户端接收更新事件。</li>
</ul>
<p>我们做两点假设：</p>
<ul>
<li>至少有一台主机会继续运行。如果两台主机都崩溃了，那我们将丢失所有的服务端数据，无法恢复。</li>
<li>不同的客户端不会同时更新同一个键值对。客户端的更新事件会先后到达两个服务器，因此更新的顺序可能会不一致。单个客户端的更新事件到达两台服务器的顺序是相同的，所以不用担心。</li>
</ul>
<p>下面是整体架构图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">+--------------------+                 +--------------------+</div><div class="line">|                    |      Binary     |                    |</div><div class="line">|       Primary      |&lt;---------------&gt;|       Backup       |</div><div class="line">|                    |       Star      |                    |</div><div class="line">+-----+--------+-----+                 +-----+--------+-----+</div><div class="line">| PUB | ROUTER | SUB |                 | PUB | ROUTER | SUB |</div><div class="line">\--+--+--------+-----/                 \-----+--------+-----/</div><div class="line">   |       ^      ^                                      ^</div><div class="line">   |       |      |                                      |</div><div class="line">   |       |      |                                      |</div><div class="line">   |       |      +--------------------------------------/</div><div class="line">   |       |      |</div><div class="line">   v       |      |</div><div class="line">/-----+----+---+--+--\</div><div class="line">| SUB |  REQ   | PUB |</div><div class="line">+-----+--------+-----+</div><div class="line">|                    |</div><div class="line">|       Client       |</div><div class="line">|                    |</div><div class="line">+--------------------+</div><div class="line"></div><div class="line"></div><div class="line">       Figure # - High-availability Clone Server Pair</div></pre></td></tr></table></figure>
<p>开始编程之前，我们需要将客户端重构成一个可复用的类。在ZMQ中写异步类有时是为了练习如何写出优雅的代码，但这里我们确实是希望克隆模式可以成为一种易于使用的程序。上述架构的伸缩性来源于客户端的正确行为，因此有必要将其封装成一份API。要在客户端中进行故障恢复还是比较复杂的，试想一下自由者模式和克隆模式结合起来会是什么样的吧。</p>
<p>按照我的习惯，我会先写出一份API的列表，然后加以实现。让我们假想一个名为clone的API，在其基础之上编写克隆模式客户端API。将代码封装为API显然会提升代码的稳定性，就以模型5为例，客户端需要打开三个套接字，端点名称直接写在了代码里。我们可以创建这样一组API：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//  为每个套接字指定端点</span></div><div class="line">clone_subscribe (clone, <span class="string">"tcp://localhost:5556"</span>);</div><div class="line">clone_snapshot  (clone, <span class="string">"tcp://localhost:5557"</span>);</div><div class="line">clone_updates   (clone, <span class="string">"tcp://localhost:5558"</span>);</div><div class="line"></div><div class="line"><span class="comment">//  由于有两个服务端，因此再执行一次</span></div><div class="line">clone_subscribe (clone, <span class="string">"tcp://localhost:5566"</span>);</div><div class="line">clone_snapshot  (clone, <span class="string">"tcp://localhost:5567"</span>);</div><div class="line">clone_updates   (clone, <span class="string">"tcp://localhost:5568"</span>);</div></pre></td></tr></table></figure>
<p>但这种写法还是比较啰嗦的，因为没有必要将API内部的一些设计暴露给编程人员。现在我们会使用三个套接字，而将来可能就会使用两个，或者四个。我们不可能让所有的应用程序都相应地修改吧？让我们把这些信息包装到API中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//  指定主备服务器端点</span></div><div class="line">clone_connect (clone, <span class="string">"tcp://localhost:5551"</span>);</div><div class="line">clone_connect (clone, <span class="string">"tcp://localhost:5561"</span>);</div></pre></td></tr></table></figure>
<p>这样一来代码就变得非常简介，不过也会对现有代码的内部就够造成影响。我们需要从一个端点中推算出三个端点。一种方法是假设客户端和服务端使用三个连续的端点通信，并将这个规则写入协议；另一个方法是向服务器索取缺少的端点信息。我们使用第一种较为简单的方法：</p>
<ul>
<li>服务器状态ROUTER在端点P；</li>
<li>服务器更新事件PUB在端点P + 1；</li>
<li>服务器更新事件SUB在端点P + 2。</li>
</ul>
<p>clone类和第四章的flcliapi类很类似，由两部分组成：</p>
<ul>
<li>一个在后台运行的异步克隆模式代理。该代理处理所有的I/O操作，实时地和服务器进行通信；</li>
<li>一个在前台应用程序中同步运行的clone类。当你创建了一个clone对象后，它会自动创建后台的clone线程；当你销毁clone对象，该后台线程也会被销毁。</li>
</ul>
<p>前台的clone类会使用inproc管道和后台的代理进行通信。C语言中，czmq线程会自动为我们创建这个管道。这也是ZMQ多线程编程的常规方式。</p>
<p>如果没有ZMQ，这种异步的设计将很难处理高压工作，而ZMQ会让其变得简单。编写出来额代码会相对比较复杂。我们可以用反应堆的模式来编写，但这会进一步增加复杂度，且影响应用程序的使用。因此，我们的设计的API将更像是一个能够和服务器进行通信的键值表：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">clone_t</span> *clone_new (<span class="keyword">void</span>);</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">clone_destroy</span> <span class="params">(<span class="keyword">clone_t</span> **self_p)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">clone_connect</span> <span class="params">(<span class="keyword">clone_t</span> *self, <span class="keyword">char</span> *address, <span class="keyword">char</span> *service)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">clone_set</span> <span class="params">(<span class="keyword">clone_t</span> *self, <span class="keyword">char</span> *key, <span class="keyword">char</span> *value)</span></span>;</div><div class="line"><span class="function"><span class="keyword">char</span> *<span class="title">clone_get</span> <span class="params">(<span class="keyword">clone_t</span> *self, <span class="keyword">char</span> *key)</span></span>;</div></pre></td></tr></table></figure>
<p>下面就是克隆模式客户端模型6的代码，因为调用了API，所以非常简短：<br><strong>clonecli6: Clone client, Model Six in C</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">//</div><div class="line">//  克隆模式 - 客户端 - 模型6</div><div class="line">//</div><div class="line"></div><div class="line">//  直接编译，不建类库</div><div class="line">#include &quot;clone.c&quot;</div><div class="line"></div><div class="line">#define SUBTREE &quot;/client/&quot;</div><div class="line"></div><div class="line">int main (void)</div><div class="line">&#123;</div><div class="line">    //  创建分布式哈希表</div><div class="line">    clone_t *clone = clone_new ();</div><div class="line"></div><div class="line">    //  配置</div><div class="line">    clone_subtree (clone, SUBTREE);</div><div class="line">    clone_connect (clone, &quot;tcp://localhost&quot;, &quot;5556&quot;);</div><div class="line">    clone_connect (clone, &quot;tcp://localhost&quot;, &quot;5566&quot;);</div><div class="line"></div><div class="line">    //  插入随机键值</div><div class="line">    while (!zctx_interrupted) &#123;</div><div class="line">        //  生成随机值</div><div class="line">        char key [255];</div><div class="line">        char value [10];</div><div class="line">        sprintf (key, &quot;%s%d&quot;, SUBTREE, randof (10000));</div><div class="line">        sprintf (value, &quot;%d&quot;, randof (1000000));</div><div class="line">        clone_set (clone, key, value, randof (30));</div><div class="line">        sleep (1);</div><div class="line">    &#125;</div><div class="line">    clone_destroy (&amp;clone);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以下是clone类的实现：<br><strong>clone: Clone class in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*  =====================================================================</span></div><div class="line">    clone - client-side Clone Pattern class</div><div class="line"></div><div class="line">    ---------------------------------------------------------------------</div><div class="line">    Copyright (c) 1991-2011 iMatix Corporation &lt;www.imatix.com&gt;</div><div class="line">    Copyright other contributors as noted in the AUTHORS file.</div><div class="line"></div><div class="line">    This file is part of the ZeroMQ Guide: http://zguide.zeromq.org</div><div class="line"></div><div class="line">    This is free software; you can redistribute it and/or modify it under</div><div class="line">    the terms of the GNU Lesser General Public License as published by</div><div class="line">    the Free Software Foundation; either version 3 of the License, or (at</div><div class="line">    your option) any later version.</div><div class="line"></div><div class="line">    This software is distributed in the hope that it will be useful, but</div><div class="line">    WITHOUT ANY WARRANTY; without even the implied warranty of</div><div class="line">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</div><div class="line">    Lesser General Public License for more details.</div><div class="line"></div><div class="line">    You should have received a copy of the GNU Lesser General Public</div><div class="line">    License along with this program. If not, see</div><div class="line">    &lt;http://www.gnu.org/licenses/&gt;.</div><div class="line">    =====================================================================</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"clone.h"</span></span></div><div class="line"></div><div class="line"><span class="comment">//  请求超时时间</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GLOBAL_TIMEOUT  4000    <span class="comment">//  msecs</span></span></div><div class="line"><span class="comment">//  判定服务器死亡的时间</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVER_TTL      5000    <span class="comment">//  msecs</span></span></div><div class="line"><span class="comment">//  服务器数量</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVER_MAX      2</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  =====================================================================</span></div><div class="line"><span class="comment">//  同步部分，在应用程序线程中工作</span></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  类结构</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">clone_t</span> &#123;</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx;                <span class="comment">//  上下文</span></div><div class="line">    <span class="keyword">void</span> *pipe;                 <span class="comment">//  和后台代理间的通信套接字</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//  该线程用于处理真正的clone类</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clone_agent</span> <span class="params">(<span class="keyword">void</span> *args, <span class="keyword">zctx_t</span> *ctx, <span class="keyword">void</span> *pipe)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  构造函数</span></div><div class="line"></div><div class="line"><span class="keyword">clone_t</span> *</div><div class="line">clone_new (<span class="keyword">void</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">clone_t</span></div><div class="line">        *self;</div><div class="line"></div><div class="line">    self = (<span class="keyword">clone_t</span> *) zmalloc (<span class="keyword">sizeof</span> (<span class="keyword">clone_t</span>));</div><div class="line">    self-&gt;ctx = zctx_new ();</div><div class="line">    self-&gt;pipe = zthread_fork (self-&gt;ctx, clone_agent, <span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">return</span> self;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  析构函数</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">clone_destroy</span> <span class="params">(<span class="keyword">clone_t</span> **self_p)</span></div><div class="line">&#123;</div><div class="line">    assert (self_p);</div><div class="line">    <span class="keyword">if</span> (*self_p) &#123;</div><div class="line">        <span class="keyword">clone_t</span> *self = *self_p;</div><div class="line">        zctx_destroy (&amp;self-&gt;ctx);</div><div class="line">        <span class="built_in">free</span> (self);</div><div class="line">        *self_p = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  在链接之前指定快照和更新事件的子树</span></div><div class="line"><span class="comment">//  发送给后台代理的消息内容为[SUBTREE][subtree]</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">clone_subtree</span> <span class="params">(<span class="keyword">clone_t</span> *self, <span class="keyword">char</span> *subtree)</span></span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">zmsg_t</span> *msg = zmsg_new ();</div><div class="line">    zmsg_addstr (msg, <span class="string">"SUBTREE"</span>);</div><div class="line">    zmsg_addstr (msg, subtree);</div><div class="line">    zmsg_send (&amp;msg, self-&gt;pipe);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  连接至新的服务器端点</span></div><div class="line"><span class="comment">//  消息内容：[CONNECT][endpoint][service]</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">clone_connect</span> <span class="params">(<span class="keyword">clone_t</span> *self, <span class="keyword">char</span> *address, <span class="keyword">char</span> *service)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">zmsg_t</span> *msg = zmsg_new ();</div><div class="line">    zmsg_addstr (msg, <span class="string">"CONNECT"</span>);</div><div class="line">    zmsg_addstr (msg, address);</div><div class="line">    zmsg_addstr (msg, service);</div><div class="line">    zmsg_send (&amp;msg, self-&gt;pipe);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  设置新值</span></div><div class="line"><span class="comment">//  消息内容：[SET][key][value][ttl]</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">clone_set</span> <span class="params">(<span class="keyword">clone_t</span> *self, <span class="keyword">char</span> *key, <span class="keyword">char</span> *value, <span class="keyword">int</span> ttl)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> ttlstr [<span class="number">10</span>];</div><div class="line">    <span class="built_in">sprintf</span> (ttlstr, <span class="string">"%d"</span>, ttl);</div><div class="line"></div><div class="line">    assert (self);</div><div class="line">    <span class="keyword">zmsg_t</span> *msg = zmsg_new ();</div><div class="line">    zmsg_addstr (msg, <span class="string">"SET"</span>);</div><div class="line">    zmsg_addstr (msg, key);</div><div class="line">    zmsg_addstr (msg, value);</div><div class="line">    zmsg_addstr (msg, ttlstr);</div><div class="line">    zmsg_send (&amp;msg, self-&gt;pipe);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  取值</span></div><div class="line"><span class="comment">//  消息内容：[GET][key]</span></div><div class="line"><span class="comment">//  如果没有clone可用，会返回NULL</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span> *</span></div><div class="line"><span class="title">clone_get</span> <span class="params">(<span class="keyword">clone_t</span> *self, <span class="keyword">char</span> *key)</span></div><div class="line">&#123;</div><div class="line">    assert (self);</div><div class="line">    assert (key);</div><div class="line">    <span class="keyword">zmsg_t</span> *msg = zmsg_new ();</div><div class="line">    zmsg_addstr (msg, <span class="string">"GET"</span>);</div><div class="line">    zmsg_addstr (msg, key);</div><div class="line">    zmsg_send (&amp;msg, self-&gt;pipe);</div><div class="line"></div><div class="line">    <span class="keyword">zmsg_t</span> *reply = zmsg_recv (self-&gt;pipe);</div><div class="line">    <span class="keyword">if</span> (reply) &#123;</div><div class="line">        <span class="keyword">char</span> *value = zmsg_popstr (reply);</div><div class="line">        zmsg_destroy (&amp;reply);</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  =====================================================================</span></div><div class="line"><span class="comment">//  异步部分，在后台运行</span></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  单个服务端信息</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    <span class="keyword">char</span> *address;              <span class="comment">//  服务端地址</span></div><div class="line">    <span class="keyword">int</span> port;                   <span class="comment">//  端口</span></div><div class="line">    <span class="keyword">void</span> *snapshot;             <span class="comment">//  快照套接字</span></div><div class="line">    <span class="keyword">void</span> *subscriber;           <span class="comment">//  接收更新事件的套接字</span></div><div class="line">    <span class="keyword">uint64_t</span> expiry;            <span class="comment">//  服务器过期时间</span></div><div class="line">    uint requests;              <span class="comment">//  收到的快照请求数</span></div><div class="line">&#125; <span class="keyword">server_t</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> server_t *</span></div><div class="line"><span class="title">server_new</span> <span class="params">(<span class="keyword">zctx_t</span> *ctx, <span class="keyword">char</span> *address, <span class="keyword">int</span> port, <span class="keyword">char</span> *subtree)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">server_t</span> *self = (<span class="keyword">server_t</span> *) zmalloc (<span class="keyword">sizeof</span> (<span class="keyword">server_t</span>));</div><div class="line"></div><div class="line">    zclock_log (<span class="string">"I: adding server %s:%d..."</span>, address, port);</div><div class="line">    self-&gt;address = strdup (address);</div><div class="line">    self-&gt;port = port;</div><div class="line"></div><div class="line">    self-&gt;snapshot = zsocket_new (ctx, ZMQ_DEALER);</div><div class="line">    zsocket_connect (self-&gt;snapshot, <span class="string">"%s:%d"</span>, address, port);</div><div class="line">    self-&gt;subscriber = zsocket_new (ctx, ZMQ_SUB);</div><div class="line">    zsocket_connect (self-&gt;subscriber, <span class="string">"%s:%d"</span>, address, port + <span class="number">1</span>);</div><div class="line">    zsockopt_set_subscribe (self-&gt;subscriber, subtree);</div><div class="line">    <span class="keyword">return</span> self;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">server_destroy</span> <span class="params">(<span class="keyword">server_t</span> **self_p)</span></div><div class="line">&#123;</div><div class="line">    assert (self_p);</div><div class="line">    <span class="keyword">if</span> (*self_p) &#123;</div><div class="line">        <span class="keyword">server_t</span> *self = *self_p;</div><div class="line">        <span class="built_in">free</span> (self-&gt;address);</div><div class="line">        <span class="built_in">free</span> (self);</div><div class="line">        *self_p = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  后台代理类</span></div><div class="line"></div><div class="line"><span class="comment">//  状态</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> STATE_INITIAL       0   <span class="comment">//  连接之前</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> STATE_SYNCING       1   <span class="comment">//  正在同步</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> STATE_ACTIVE        2   <span class="comment">//  正在更新</span></span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx;                <span class="comment">//  上下文</span></div><div class="line">    <span class="keyword">void</span> *pipe;                 <span class="comment">//  与主线程通信的套接字</span></div><div class="line">    <span class="keyword">zhash_t</span> *kvmap;             <span class="comment">//  键值表</span></div><div class="line">    <span class="keyword">char</span> *subtree;              <span class="comment">//  子树</span></div><div class="line">    <span class="keyword">server_t</span> *server [SERVER_MAX];</div><div class="line">    uint nbr_servers;           <span class="comment">//  范围：0 - SERVER_MAX</span></div><div class="line">    uint state;                 <span class="comment">//  当前状态</span></div><div class="line">    uint cur_server;            <span class="comment">//  当前master，0/1</span></div><div class="line">    <span class="keyword">int64_t</span> sequence;           <span class="comment">//  键值对编号</span></div><div class="line">    <span class="keyword">void</span> *publisher;            <span class="comment">//  发布更新事件的套接字</span></div><div class="line">&#125; <span class="keyword">agent_t</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> agent_t *</span></div><div class="line"><span class="title">agent_new</span> <span class="params">(<span class="keyword">zctx_t</span> *ctx, <span class="keyword">void</span> *pipe)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">agent_t</span> *self = (<span class="keyword">agent_t</span> *) zmalloc (<span class="keyword">sizeof</span> (<span class="keyword">agent_t</span>));</div><div class="line">    self-&gt;ctx = ctx;</div><div class="line">    self-&gt;pipe = pipe;</div><div class="line">    self-&gt;kvmap = zhash_new ();</div><div class="line">    self-&gt;subtree = strdup (<span class="string">""</span>);</div><div class="line">    self-&gt;state = STATE_INITIAL;</div><div class="line">    self-&gt;publisher = zsocket_new (self-&gt;ctx, ZMQ_PUB);</div><div class="line">    <span class="keyword">return</span> self;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">agent_destroy</span> <span class="params">(<span class="keyword">agent_t</span> **self_p)</span></div><div class="line">&#123;</div><div class="line">    assert (self_p);</div><div class="line">    <span class="keyword">if</span> (*self_p) &#123;</div><div class="line">        <span class="keyword">agent_t</span> *self = *self_p;</div><div class="line">        <span class="keyword">int</span> server_nbr;</div><div class="line">        <span class="keyword">for</span> (server_nbr = <span class="number">0</span>; server_nbr &lt; self-&gt;nbr_servers; server_nbr++)</div><div class="line">            server_destroy (&amp;self-&gt;server [server_nbr]);</div><div class="line">        zhash_destroy (&amp;self-&gt;kvmap);</div><div class="line">        <span class="built_in">free</span> (self-&gt;subtree);</div><div class="line">        <span class="built_in">free</span> (self);</div><div class="line">        *self_p = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  若线程被中断则返回-1</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">agent_control_message</span> <span class="params">(<span class="keyword">agent_t</span> *self)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">zmsg_t</span> *msg = zmsg_recv (self-&gt;pipe);</div><div class="line">    <span class="keyword">char</span> *command = zmsg_popstr (msg);</div><div class="line">    <span class="keyword">if</span> (command == <span class="literal">NULL</span>)</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (streq (command, <span class="string">"SUBTREE"</span>)) &#123;</div><div class="line">        <span class="built_in">free</span> (self-&gt;subtree);</div><div class="line">        self-&gt;subtree = zmsg_popstr (msg);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    <span class="keyword">if</span> (streq (command, <span class="string">"CONNECT"</span>)) &#123;</div><div class="line">        <span class="keyword">char</span> *address = zmsg_popstr (msg);</div><div class="line">        <span class="keyword">char</span> *service = zmsg_popstr (msg);</div><div class="line">        <span class="keyword">if</span> (self-&gt;nbr_servers &lt; SERVER_MAX) &#123;</div><div class="line">            self-&gt;server [self-&gt;nbr_servers++] = server_new (</div><div class="line">                self-&gt;ctx, address, atoi (service), self-&gt;subtree);</div><div class="line">            <span class="comment">//  广播更新事件</span></div><div class="line">            zsocket_connect (self-&gt;publisher, <span class="string">"%s:%d"</span>,</div><div class="line">                address, atoi (service) + <span class="number">2</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            zclock_log (<span class="string">"E: too many servers (max. %d)"</span>, SERVER_MAX);</div><div class="line">        <span class="built_in">free</span> (address);</div><div class="line">        <span class="built_in">free</span> (service);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    <span class="keyword">if</span> (streq (command, <span class="string">"SET"</span>)) &#123;</div><div class="line">        <span class="keyword">char</span> *key = zmsg_popstr (msg);</div><div class="line">        <span class="keyword">char</span> *value = zmsg_popstr (msg);</div><div class="line">        <span class="keyword">char</span> *ttl = zmsg_popstr (msg);</div><div class="line">        zhash_update (self-&gt;kvmap, key, (byte *) value);</div><div class="line">        zhash_freefn (self-&gt;kvmap, key, <span class="built_in">free</span>);</div><div class="line"></div><div class="line">        <span class="comment">//  向服务端发送键值对</span></div><div class="line">        <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (<span class="number">0</span>);</div><div class="line">        kvmsg_set_key  (kvmsg, key);</div><div class="line">        kvmsg_set_uuid (kvmsg);</div><div class="line">        kvmsg_fmt_body (kvmsg, <span class="string">"%s"</span>, value);</div><div class="line">        kvmsg_set_prop (kvmsg, <span class="string">"ttl"</span>, ttl);</div><div class="line">        kvmsg_send     (kvmsg, self-&gt;publisher);</div><div class="line">        kvmsg_destroy (&amp;kvmsg);</div><div class="line"><span class="built_in">puts</span> (key);</div><div class="line">        <span class="built_in">free</span> (ttl);</div><div class="line">        <span class="built_in">free</span> (key);             <span class="comment">//  键值对实际由哈希表对象控制</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    <span class="keyword">if</span> (streq (command, <span class="string">"GET"</span>)) &#123;</div><div class="line">        <span class="keyword">char</span> *key = zmsg_popstr (msg);</div><div class="line">        <span class="keyword">char</span> *value = zhash_lookup (self-&gt;kvmap, key);</div><div class="line">        <span class="keyword">if</span> (value)</div><div class="line">            zstr_send (self-&gt;pipe, value);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            zstr_send (self-&gt;pipe, <span class="string">""</span>);</div><div class="line">        <span class="built_in">free</span> (key);</div><div class="line">        <span class="built_in">free</span> (value);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">free</span> (command);</div><div class="line">    zmsg_destroy (&amp;msg);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  异步的后台代理会维护一个服务端池，并处理来自应用程序的请求或应答。</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">clone_agent</span> <span class="params">(<span class="keyword">void</span> *args, <span class="keyword">zctx_t</span> *ctx, <span class="keyword">void</span> *pipe)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">agent_t</span> *self = agent_new (ctx, pipe);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (TRUE) &#123;</div><div class="line">        <span class="keyword">zmq_pollitem_t</span> poll_set [] = &#123;</div><div class="line">            &#123; pipe, <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125;,</div><div class="line">            &#123; <span class="number">0</span>,    <span class="number">0</span>, ZMQ_POLLIN, <span class="number">0</span> &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">int</span> poll_timer = <span class="number">-1</span>;</div><div class="line">        <span class="keyword">int</span> poll_size = <span class="number">2</span>;</div><div class="line">        <span class="keyword">server_t</span> *server = self-&gt;server [self-&gt;cur_server];</div><div class="line">        <span class="keyword">switch</span> (self-&gt;state) &#123;</div><div class="line">            <span class="keyword">case</span> STATE_INITIAL:</div><div class="line">                <span class="comment">//  该状态下，如果有可用服务，会发送快照请求</span></div><div class="line">                <span class="keyword">if</span> (self-&gt;nbr_servers &gt; <span class="number">0</span>) &#123;</div><div class="line">                    zclock_log (<span class="string">"I: 正在等待服务器 %s:%d..."</span>,</div><div class="line">                        server-&gt;address, server-&gt;port);</div><div class="line">                    <span class="keyword">if</span> (server-&gt;requests &lt; <span class="number">2</span>) &#123;</div><div class="line">                        zstr_sendm (server-&gt;snapshot, <span class="string">"ICANHAZ?"</span>);</div><div class="line">                        zstr_send  (server-&gt;snapshot, self-&gt;subtree);</div><div class="line">                        server-&gt;requests++;</div><div class="line">                    &#125;</div><div class="line">                    server-&gt;expiry = zclock_time () + SERVER_TTL;</div><div class="line">                    self-&gt;state = STATE_SYNCING;</div><div class="line">                    poll_set [<span class="number">1</span>].socket = server-&gt;snapshot;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    poll_size = <span class="number">1</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> STATE_SYNCING:</div><div class="line">                <span class="comment">//  该状态下我们从服务器端接收快照内容，若失败则尝试其他服务器</span></div><div class="line">                poll_set [<span class="number">1</span>].socket = server-&gt;snapshot;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> STATE_ACTIVE:</div><div class="line">                <span class="comment">//  该状态下我们从服务器获取更新事件，失败则尝试其他服务器</span></div><div class="line">                poll_set [<span class="number">1</span>].socket = server-&gt;subscriber;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (server) &#123;</div><div class="line">            poll_timer = (server-&gt;expiry - zclock_time ())</div><div class="line">                       * ZMQ_POLL_MSEC;</div><div class="line">            <span class="keyword">if</span> (poll_timer &lt; <span class="number">0</span>)</div><div class="line">                poll_timer = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  ------------------------------------------------------------</span></div><div class="line">        <span class="comment">//  poll循环</span></div><div class="line">        <span class="keyword">int</span> rc = zmq_poll (poll_set, poll_size, poll_timer);</div><div class="line">        <span class="keyword">if</span> (rc == <span class="number">-1</span>)</div><div class="line">            <span class="keyword">break</span>;              <span class="comment">//  上下文已被关闭</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (poll_set [<span class="number">0</span>].revents &amp; ZMQ_POLLIN) &#123;</div><div class="line">            <span class="keyword">if</span> (agent_control_message (self))</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        <span class="keyword">if</span> (poll_set [<span class="number">1</span>].revents &amp; ZMQ_POLLIN) &#123;</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (poll_set [<span class="number">1</span>].socket);</div><div class="line">            <span class="keyword">if</span> (!kvmsg)</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line"></div><div class="line">            <span class="comment">//  任何服务端的消息将重置它的过期时间</span></div><div class="line">            server-&gt;expiry = zclock_time () + SERVER_TTL;</div><div class="line">            <span class="keyword">if</span> (self-&gt;state == STATE_SYNCING) &#123;</div><div class="line">                <span class="comment">//  保存快照内容</span></div><div class="line">                server-&gt;requests = <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (streq (kvmsg_key (kvmsg), <span class="string">"KTHXBAI"</span>)) &#123;</div><div class="line">                    self-&gt;sequence = kvmsg_sequence (kvmsg);</div><div class="line">                    self-&gt;state = STATE_ACTIVE;</div><div class="line">                    zclock_log (<span class="string">"I: received from %s:%d snapshot=%d"</span>,</div><div class="line">                        server-&gt;address, server-&gt;port,</div><div class="line">                        (<span class="keyword">int</span>) self-&gt;sequence);</div><div class="line">                    kvmsg_destroy (&amp;kvmsg);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    kvmsg_store (&amp;kvmsg, self-&gt;kvmap);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            <span class="keyword">if</span> (self-&gt;state == STATE_ACTIVE) &#123;</div><div class="line">                <span class="comment">//  丢弃过期的更新事件</span></div><div class="line">                <span class="keyword">if</span> (kvmsg_sequence (kvmsg) &gt; self-&gt;sequence) &#123;</div><div class="line">                    self-&gt;sequence = kvmsg_sequence (kvmsg);</div><div class="line">                    kvmsg_store (&amp;kvmsg, self-&gt;kvmap);</div><div class="line">                    zclock_log (<span class="string">"I: received from %s:%d update=%d"</span>,</div><div class="line">                        server-&gt;address, server-&gt;port,</div><div class="line">                        (<span class="keyword">int</span>) self-&gt;sequence);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    kvmsg_destroy (&amp;kvmsg);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//  服务端已死，尝试其他服务器</span></div><div class="line">            zclock_log (<span class="string">"I: 服务器 %s:%d 无响应"</span>,</div><div class="line">                    server-&gt;address, server-&gt;port);</div><div class="line">            self-&gt;cur_server = (self-&gt;cur_server + <span class="number">1</span>) % self-&gt;nbr_servers;</div><div class="line">            self-&gt;state = STATE_INITIAL;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    agent_destroy (&amp;self);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后是克隆服务器的模型6代码：</p>
<p><strong>clonesrv6: Clone server, Model Six in C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// 克隆模式 - 服务端 - 模型6</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="comment">//  直接编译，不建类库</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"bstar.c"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"kvmsg.c"</span></span></div><div class="line"></div><div class="line"><span class="comment">//  bstar反应堆API</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_snapshots</span>  <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *socket, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_collector</span>  <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *socket, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_flush_ttl</span>  <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *socket, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_send_hugz</span>  <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *socket, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_new_master</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *unused, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_new_slave</span>  <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *unused, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_subscriber</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *socket, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">//  服务端属性</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    <span class="keyword">zctx_t</span> *ctx;                <span class="comment">//  上下文</span></div><div class="line">    <span class="keyword">zhash_t</span> *kvmap;             <span class="comment">//  存放键值对</span></div><div class="line">    <span class="keyword">bstar_t</span> *bstar;             <span class="comment">//  bstar反应堆核心</span></div><div class="line">    <span class="keyword">int64_t</span> sequence;           <span class="comment">//  更新事件编号</span></div><div class="line">    <span class="keyword">int</span> port;                   <span class="comment">//  主端口</span></div><div class="line">    <span class="keyword">int</span> peer;                   <span class="comment">//  同伴端口</span></div><div class="line">    <span class="keyword">void</span> *publisher;            <span class="comment">//  发布更新事件的端口</span></div><div class="line">    <span class="keyword">void</span> *collector;            <span class="comment">//  接收客户端更新事件的端口</span></div><div class="line">    <span class="keyword">void</span> *subscriber;           <span class="comment">//  接受同伴更新事件的端口</span></div><div class="line">    <span class="keyword">zlist_t</span> *pending;           <span class="comment">//  延迟的更新事件</span></div><div class="line">    Bool primary;               <span class="comment">//  是否为主机</span></div><div class="line">    Bool master;                <span class="comment">//  是否为master</span></div><div class="line">    Bool slave;                 <span class="comment">//  是否为slave</span></div><div class="line">&#125; <span class="keyword">clonesrv_t</span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv [])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) zmalloc (<span class="keyword">sizeof</span> (<span class="keyword">clonesrv_t</span>));</div><div class="line">    <span class="keyword">if</span> (argc == <span class="number">2</span> &amp;&amp; streq (argv [<span class="number">1</span>], <span class="string">"-p"</span>)) &#123;</div><div class="line">        zclock_log (<span class="string">"I: 作为主机master运行，正在等待备机slave连接。"</span>);</div><div class="line">        self-&gt;bstar = bstar_new (BSTAR_PRIMARY, <span class="string">"tcp://*:5003"</span>,</div><div class="line">                                 <span class="string">"tcp://localhost:5004"</span>);</div><div class="line">        bstar_voter (self-&gt;bstar, <span class="string">"tcp://*:5556"</span>, ZMQ_ROUTER,</div><div class="line">                     s_snapshots, self);</div><div class="line">        self-&gt;port = <span class="number">5556</span>;</div><div class="line">        self-&gt;peer = <span class="number">5566</span>;</div><div class="line">        self-&gt;primary = TRUE;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    <span class="keyword">if</span> (argc == <span class="number">2</span> &amp;&amp; streq (argv [<span class="number">1</span>], <span class="string">"-b"</span>)) &#123;</div><div class="line">        zclock_log (<span class="string">"I: 作为备机slave运行，正在等待主机master连接。"</span>);</div><div class="line">        self-&gt;bstar = bstar_new (BSTAR_BACKUP, <span class="string">"tcp://*:5004"</span>,</div><div class="line">                                 <span class="string">"tcp://localhost:5003"</span>);</div><div class="line">        bstar_voter (self-&gt;bstar, <span class="string">"tcp://*:5566"</span>, ZMQ_ROUTER,</div><div class="line">                     s_snapshots, self);</div><div class="line">        self-&gt;port = <span class="number">5566</span>;</div><div class="line">        self-&gt;peer = <span class="number">5556</span>;</div><div class="line">        self-&gt;primary = FALSE;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">printf</span> (<span class="string">"Usage: clonesrv4 &#123; -p | -b &#125;\n"</span>);</div><div class="line">        <span class="built_in">free</span> (self);</div><div class="line">        <span class="built_in">exit</span> (<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//  主机将成为master</span></div><div class="line">    <span class="keyword">if</span> (self-&gt;primary)</div><div class="line">        self-&gt;kvmap = zhash_new ();</div><div class="line"></div><div class="line">    self-&gt;ctx = zctx_new ();</div><div class="line">    self-&gt;pending = zlist_new ();</div><div class="line">    bstar_set_verbose (self-&gt;bstar, TRUE);</div><div class="line"></div><div class="line">    <span class="comment">//  设置克隆服务端套接字</span></div><div class="line">    self-&gt;publisher = zsocket_new (self-&gt;ctx, ZMQ_PUB);</div><div class="line">    self-&gt;collector = zsocket_new (self-&gt;ctx, ZMQ_SUB);</div><div class="line">    zsocket_bind (self-&gt;publisher, <span class="string">"tcp://*:%d"</span>, self-&gt;port + <span class="number">1</span>);</div><div class="line">    zsocket_bind (self-&gt;collector, <span class="string">"tcp://*:%d"</span>, self-&gt;port + <span class="number">2</span>);</div><div class="line"></div><div class="line">    <span class="comment">//  作为克隆客户端连接同伴</span></div><div class="line">    self-&gt;subscriber = zsocket_new (self-&gt;ctx, ZMQ_SUB);</div><div class="line">    zsocket_connect (self-&gt;subscriber, <span class="string">"tcp://localhost:%d"</span>, self-&gt;peer + <span class="number">1</span>);</div><div class="line"></div><div class="line">    <span class="comment">//  注册状态事件处理器</span></div><div class="line">    bstar_new_master (self-&gt;bstar, s_new_master, self);</div><div class="line">    bstar_new_slave (self-&gt;bstar, s_new_slave, self);</div><div class="line"></div><div class="line">    <span class="comment">//  注册bstar反应堆其他事件处理器</span></div><div class="line">    zloop_reader (bstar_zloop (self-&gt;bstar), self-&gt;collector, s_collector, self);</div><div class="line">    zloop_timer  (bstar_zloop (self-&gt;bstar), <span class="number">1000</span>, <span class="number">0</span>, s_flush_ttl, self);</div><div class="line">    zloop_timer  (bstar_zloop (self-&gt;bstar), <span class="number">1000</span>, <span class="number">0</span>, s_send_hugz, self);</div><div class="line"></div><div class="line">    <span class="comment">//  开启bstar反应堆</span></div><div class="line">    bstar_start (self-&gt;bstar);</div><div class="line"></div><div class="line">    <span class="comment">//  中断，终止。</span></div><div class="line">    <span class="keyword">while</span> (zlist_size (self-&gt;pending)) &#123;</div><div class="line">        <span class="keyword">kvmsg_t</span> *kvmsg = (<span class="keyword">kvmsg_t</span> *) zlist_pop (self-&gt;pending);</div><div class="line">        kvmsg_destroy (&amp;kvmsg);</div><div class="line">    &#125;</div><div class="line">    zlist_destroy (&amp;self-&gt;pending);</div><div class="line">    bstar_destroy (&amp;self-&gt;bstar);</div><div class="line">    zhash_destroy (&amp;self-&gt;kvmap);</div><div class="line">    zctx_destroy (&amp;self-&gt;ctx);</div><div class="line">    <span class="built_in">free</span> (self);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  发送快照内容</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_send_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">//  请求方信息</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    <span class="keyword">void</span> *socket;           <span class="comment">//  ROUTER套接字</span></div><div class="line">    <span class="keyword">zframe_t</span> *identity;     <span class="comment">//  请求放标识</span></div><div class="line">    <span class="keyword">char</span> *subtree;          <span class="comment">//  子树</span></div><div class="line">&#125; <span class="keyword">kvroute_t</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_snapshots</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *snapshot, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line"></div><div class="line">    <span class="keyword">zframe_t</span> *identity = zframe_recv (snapshot);</div><div class="line">    <span class="keyword">if</span> (identity) &#123;</div><div class="line">        <span class="comment">//  请求在消息的第二帧中</span></div><div class="line">        <span class="keyword">char</span> *request = zstr_recv (snapshot);</div><div class="line">        <span class="keyword">char</span> *subtree = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">if</span> (streq (request, <span class="string">"ICANHAZ?"</span>)) &#123;</div><div class="line">            <span class="built_in">free</span> (request);</div><div class="line">            subtree = zstr_recv (snapshot);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="built_in">printf</span> (<span class="string">"E: 错误的请求，正在退出……\n"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (subtree) &#123;</div><div class="line">            <span class="comment">//  发送状态快照</span></div><div class="line">            <span class="keyword">kvroute_t</span> routing = &#123; snapshot, identity, subtree &#125;;</div><div class="line">            zhash_foreach (self-&gt;kvmap, s_send_single, &amp;routing);</div><div class="line"></div><div class="line">            <span class="comment">//  发送终止消息，以及消息编号</span></div><div class="line">            zclock_log (<span class="string">"I: 正在发送快照，版本号：%d"</span>, (<span class="keyword">int</span>) self-&gt;sequence);</div><div class="line">            zframe_send (&amp;identity, snapshot, ZFRAME_MORE);</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (self-&gt;sequence);</div><div class="line">            kvmsg_set_key  (kvmsg, <span class="string">"KTHXBAI"</span>);</div><div class="line">            kvmsg_set_body (kvmsg, (byte *) subtree, <span class="number">0</span>);</div><div class="line">            kvmsg_send     (kvmsg, snapshot);</div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">            <span class="built_in">free</span> (subtree);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  每次发送一个快照键值对</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_send_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">kvroute_t</span> *kvroute = (<span class="keyword">kvroute_t</span> *) args;</div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = (<span class="keyword">kvmsg_t</span> *) data;</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span> (kvroute-&gt;subtree) &lt;= <span class="built_in">strlen</span> (kvmsg_key (kvmsg))</div><div class="line">    &amp;&amp;  <span class="built_in">memcmp</span> (kvroute-&gt;subtree,</div><div class="line">                kvmsg_key (kvmsg), <span class="built_in">strlen</span> (kvroute-&gt;subtree)) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//  先发送接收方的地址</span></div><div class="line">        zframe_send (&amp;kvroute-&gt;identity,</div><div class="line">            kvroute-&gt;socket, ZFRAME_MORE + ZFRAME_REUSE);</div><div class="line">        kvmsg_send (kvmsg, kvroute-&gt;socket);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  从客户端收集更新事件</span></div><div class="line"><span class="comment">//  如果我们是master，则将该事件写入kvmap对象；</span></div><div class="line"><span class="comment">//  如果我们是slave，则将其写入延迟队列</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_was_pending</span> <span class="params">(<span class="keyword">clonesrv_t</span> *self, <span class="keyword">kvmsg_t</span> *kvmsg)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_collector</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *collector, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line"></div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (collector);</div><div class="line">    kvmsg_dump (kvmsg);</div><div class="line">    <span class="keyword">if</span> (kvmsg) &#123;</div><div class="line">        <span class="keyword">if</span> (self-&gt;master) &#123;</div><div class="line">            kvmsg_set_sequence (kvmsg, ++self-&gt;sequence);</div><div class="line">            kvmsg_send (kvmsg, self-&gt;publisher);</div><div class="line">            <span class="keyword">int</span> ttl = atoi (kvmsg_get_prop (kvmsg, <span class="string">"ttl"</span>));</div><div class="line">            <span class="keyword">if</span> (ttl)</div><div class="line">                kvmsg_set_prop (kvmsg, <span class="string">"ttl"</span>,</div><div class="line">                    <span class="string">"%"</span> PRId64, zclock_time () + ttl * <span class="number">1000</span>);</div><div class="line">            kvmsg_store (&amp;kvmsg, self-&gt;kvmap);</div><div class="line">            zclock_log (<span class="string">"I: 正在发布更新事件：%d"</span>, (<span class="keyword">int</span>) self-&gt;sequence);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//  如果我们已经从master中获得了该事件，则丢弃该消息</span></div><div class="line">            <span class="keyword">if</span> (s_was_pending (self, kvmsg))</div><div class="line">                kvmsg_destroy (&amp;kvmsg);</div><div class="line">            <span class="keyword">else</span></div><div class="line">                zlist_append (self-&gt;pending, kvmsg);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  如果消息已在延迟队列中，则删除它并返回TRUE</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_was_pending</span> <span class="params">(<span class="keyword">clonesrv_t</span> *self, <span class="keyword">kvmsg_t</span> *kvmsg)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">kvmsg_t</span> *held = (<span class="keyword">kvmsg_t</span> *) zlist_first (self-&gt;pending);</div><div class="line">    <span class="keyword">while</span> (held) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">memcmp</span> (kvmsg_uuid (kvmsg),</div><div class="line">                    kvmsg_uuid (held), <span class="keyword">sizeof</span> (<span class="keyword">uuid_t</span>)) == <span class="number">0</span>) &#123;</div><div class="line">            zlist_remove (self-&gt;pending, held);</div><div class="line">            <span class="keyword">return</span> TRUE;</div><div class="line">        &#125;</div><div class="line">        held = (<span class="keyword">kvmsg_t</span> *) zlist_next (self-&gt;pending);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> FALSE;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  删除带有过期时间的瞬间值</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">s_flush_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_flush_ttl</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *unused, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line">    zhash_foreach (self-&gt;kvmap, s_flush_single, args);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  如果键值对过期，则进行删除操作，并广播该事件</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_flush_single</span> <span class="params">(<span class="keyword">char</span> *key, <span class="keyword">void</span> *data, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line"></div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = (<span class="keyword">kvmsg_t</span> *) data;</div><div class="line">    <span class="keyword">int64_t</span> ttl;</div><div class="line">    <span class="built_in">sscanf</span> (kvmsg_get_prop (kvmsg, <span class="string">"ttl"</span>), <span class="string">"%"</span> PRId64, &amp;ttl);</div><div class="line">    <span class="keyword">if</span> (ttl &amp;&amp; zclock_time () &gt;= ttl) &#123;</div><div class="line">        kvmsg_set_sequence (kvmsg, ++self-&gt;sequence);</div><div class="line">        kvmsg_set_body (kvmsg, (byte *) <span class="string">""</span>, <span class="number">0</span>);</div><div class="line">        kvmsg_send (kvmsg, self-&gt;publisher);</div><div class="line">        kvmsg_store (&amp;kvmsg, self-&gt;kvmap);</div><div class="line">        zclock_log (<span class="string">"I: 正在发布删除事件：%d"</span>, (<span class="keyword">int</span>) self-&gt;sequence);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  发送心跳</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_send_hugz</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *unused, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line"></div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_new (self-&gt;sequence);</div><div class="line">    kvmsg_set_key  (kvmsg, <span class="string">"HUGZ"</span>);</div><div class="line">    kvmsg_set_body (kvmsg, (byte *) <span class="string">""</span>, <span class="number">0</span>);</div><div class="line">    kvmsg_send     (kvmsg, self-&gt;publisher);</div><div class="line">    kvmsg_destroy (&amp;kvmsg);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  状态改变事件处理函数</span></div><div class="line"><span class="comment">//  我们将转变为master</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">//  备机先将延迟列表中的事件更新到自己的快照中，</span></div><div class="line"><span class="comment">//  并开始接收客户端发来的快照请求。</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_new_master</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *unused, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line"></div><div class="line">    self-&gt;master = TRUE;</div><div class="line">    self-&gt;slave = FALSE;</div><div class="line">    zloop_cancel (bstar_zloop (self-&gt;bstar), self-&gt;subscriber);</div><div class="line"></div><div class="line">    <span class="comment">//  应用延迟列表中的事件</span></div><div class="line">    <span class="keyword">while</span> (zlist_size (self-&gt;pending)) &#123;</div><div class="line">        <span class="keyword">kvmsg_t</span> *kvmsg = (<span class="keyword">kvmsg_t</span> *) zlist_pop (self-&gt;pending);</div><div class="line">        kvmsg_set_sequence (kvmsg, ++self-&gt;sequence);</div><div class="line">        kvmsg_send (kvmsg, self-&gt;publisher);</div><div class="line">        kvmsg_store (&amp;kvmsg, self-&gt;kvmap);</div><div class="line">        zclock_log (<span class="string">"I: 正在发布延迟列表中的更新事件：%d"</span>, (<span class="keyword">int</span>) self-&gt;sequence);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  正在切换为slave</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_new_slave</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *unused, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line"></div><div class="line">    zhash_destroy (&amp;self-&gt;kvmap);</div><div class="line">    self-&gt;master = FALSE;</div><div class="line">    self-&gt;slave = TRUE;</div><div class="line">    zloop_reader (bstar_zloop (self-&gt;bstar), self-&gt;subscriber,</div><div class="line">                  s_subscriber, self);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//  ---------------------------------------------------------------------</span></div><div class="line"><span class="comment">//  从同伴主机（master）接收更新事件；</span></div><div class="line"><span class="comment">//  接收该类更新事件时，我们一定是slave。</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line"><span class="title">s_subscriber</span> <span class="params">(<span class="keyword">zloop_t</span> *loop, <span class="keyword">void</span> *subscriber, <span class="keyword">void</span> *args)</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">clonesrv_t</span> *self = (<span class="keyword">clonesrv_t</span> *) args;</div><div class="line">    <span class="comment">//  获取快照，如果需要的话。</span></div><div class="line">    <span class="keyword">if</span> (self-&gt;kvmap == <span class="literal">NULL</span>) &#123;</div><div class="line">        self-&gt;kvmap = zhash_new ();</div><div class="line">        <span class="keyword">void</span> *snapshot = zsocket_new (self-&gt;ctx, ZMQ_DEALER);</div><div class="line">        zsocket_connect (snapshot, <span class="string">"tcp://localhost:%d"</span>, self-&gt;peer);</div><div class="line">        zclock_log (<span class="string">"I: 正在请求快照：tcp://localhost:%d"</span>,</div><div class="line">                    self-&gt;peer);</div><div class="line">        zstr_send (snapshot, <span class="string">"ICANHAZ?"</span>);</div><div class="line">        <span class="keyword">while</span> (TRUE) &#123;</div><div class="line">            <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (snapshot);</div><div class="line">            <span class="keyword">if</span> (!kvmsg)</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  中断</span></div><div class="line">            <span class="keyword">if</span> (streq (kvmsg_key (kvmsg), <span class="string">"KTHXBAI"</span>)) &#123;</div><div class="line">                self-&gt;sequence = kvmsg_sequence (kvmsg);</div><div class="line">                kvmsg_destroy (&amp;kvmsg);</div><div class="line">                <span class="keyword">break</span>;          <span class="comment">//  完成</span></div><div class="line">            &#125;</div><div class="line">            kvmsg_store (&amp;kvmsg, self-&gt;kvmap);</div><div class="line">        &#125;</div><div class="line">        zclock_log (<span class="string">"I: 收到快照，版本号：%d"</span>, (<span class="keyword">int</span>) self-&gt;sequence);</div><div class="line">        zsocket_destroy (self-&gt;ctx, snapshot);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//  查找并删除</span></div><div class="line">    <span class="keyword">kvmsg_t</span> *kvmsg = kvmsg_recv (subscriber);</div><div class="line">    <span class="keyword">if</span> (!kvmsg)</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (strneq (kvmsg_key (kvmsg), <span class="string">"HUGZ"</span>)) &#123;</div><div class="line">        <span class="keyword">if</span> (!s_was_pending (self, kvmsg)) &#123;</div><div class="line">            <span class="comment">//  如果master的更新事件比客户端的事件早到，则将master的事件存入延迟列表，</span></div><div class="line">            <span class="comment">//  当收到客户端更新事件时会将其从列表中清除。</span></div><div class="line">            zlist_append (self-&gt;pending, kvmsg_dup (kvmsg));</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//  如果更新事件比kvmap版本高，则应用它</span></div><div class="line">        <span class="keyword">if</span> (kvmsg_sequence (kvmsg) &gt; self-&gt;sequence) &#123;</div><div class="line">            self-&gt;sequence = kvmsg_sequence (kvmsg);</div><div class="line">            kvmsg_store (&amp;kvmsg, self-&gt;kvmap);</div><div class="line">            zclock_log (<span class="string">"I: 收到更新事件：%d"</span>, (<span class="keyword">int</span>) self-&gt;sequence);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            kvmsg_destroy (&amp;kvmsg);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        kvmsg_destroy (&amp;kvmsg);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段程序只有几百行，但还是花了一些时间来进行调通的。这个模型中包含了故障恢复，瞬间值，子树等等。虽然我们前期设计得很完备，但要在多个套接字之间进行调试还是很困难的。以下是我的工作方式：</p>
<ul>
<li><p>由于使用了反应堆（bstar，建立在zloop之上），我们节省了大量的代码，让程序变得简洁明了。整个服务以一个线程运行，因此不会出现跨线程的问题。只需将结构指针（self）传递给所有的处理器即可。此外，使用发应堆后可以让代码更为模块化，易于重用。</p>
</li>
<li><p>我们逐个模块进行调试，只有某个模块能够正常运行时才会进入下一步。由于使用了四五个套接字，因此调试的工作量是很大的。我直接将调试信息输出到了屏幕上，因为实在没有必要专门开一个调试器来工作。</p>
</li>
<li><p>因为一直在使用valgrind工具进行测试，因此我能确定程序没有内存泄漏的问题。在C语言中，内存泄漏是我们非常关心的问题，因为没有什么垃圾回收机制可以帮你完成。正确地使用像kvmsg、czmq之类的抽象层可以很好地避免内存泄漏。</p>
</li>
</ul>
<p>这段程序肯定还会存在一些BUG，部分读者可能会帮助我调试和修复，我在此表示感谢。</p>
<p>测试模型6时，先开启主机和备机，再打开一组客户端，顺序随意。随机地中止某个服务进程，如果程序设计得是正确的，那客户端获得的数据应该都是一致的。</p>
<h4 id="克隆模式协议"><a href="#克隆模式协议" class="headerlink" title="克隆模式协议"></a>克隆模式协议</h4><p>花费了那么多精力来开发一套可靠的发布-订阅模式机制，我们当然希望将来能够方便地在其基础之上进行扩展。较好的方法是将其编写为一个协议，这样就能让各种语言来实现它了。</p>
<p>我们将其称为“集群化哈希表协议”，这是一个能够跨集群地进行键值哈希表管理，提供了多客户端的通信机制；客户端可以只操作一个子树的数据，包括更新和定义瞬间值。</p>
<ul>
<li><a href="http://rfc.zeromq.org/spec:12" target="_blank" rel="external">http://rfc.zeromq.org/spec:12</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/27/the-difference-of-fork-vfork-clone/" rel="next" title="the difference of fork vfork clone">
                <i class="fa fa-chevron-left"></i> the difference of fork vfork clone
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/02/zmq-chapter4/" rel="prev" title="zmq-chapter4">
                zmq-chapter4 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="徐松" />
          <p class="site-author-name" itemprop="name">徐松</p>
           
              <p class="site-description motion-element" itemprop="description">天黑请闭眼</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#第五章-高级发布-订阅模式"><span class="nav-number">1.</span> <span class="nav-text">第五章 高级发布-订阅模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#检测慢订阅者（自杀的蜗牛模式）"><span class="nav-number">1.1.</span> <span class="nav-text">检测慢订阅者（自杀的蜗牛模式）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高速订阅者（黑箱模式）"><span class="nav-number">1.2.</span> <span class="nav-text">高速订阅者（黑箱模式）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#共享键值缓存（克隆模式）"><span class="nav-number">1.3.</span> <span class="nav-text">共享键值缓存（克隆模式）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#分发键值更新事件"><span class="nav-number">1.3.1.</span> <span class="nav-text">分发键值更新事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建快照"><span class="nav-number">1.3.2.</span> <span class="nav-text">创建快照</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重发键值更新事件"><span class="nav-number">1.3.3.</span> <span class="nav-text">重发键值更新事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#子树克隆"><span class="nav-number">1.3.4.</span> <span class="nav-text">子树克隆</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#瞬间值"><span class="nav-number">1.3.5.</span> <span class="nav-text">瞬间值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#克隆服务器的可靠性"><span class="nav-number">1.3.6.</span> <span class="nav-text">克隆服务器的可靠性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#克隆模式协议"><span class="nav-number">1.3.7.</span> <span class="nav-text">克隆模式协议</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">徐松</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
